import { Component, Input, ViewChild, TemplateRef, Output, EventEmitter, ContentChild, ViewChildren } from '@angular/core';
import { Subject, Subscription } from 'rxjs';
import { ListRowDirective } from '../utils/list-row/list-row.directive';
import { EmptyListMessageDirective } from '../utils/empty-list-message/empty-list-message.directive';
import { SiiGroupedInfiniteScrollDataSource } from './utils/sii-grouped-infinite-scroll-data-source';
import { AutoHideRowDirective } from '../utils/auto-hide-row/auto-hide-row.directive';
import { debounceTime } from 'rxjs/operators';
import { BannerFeedbackComponent } from '../../feedback/banner-feedback/banner-feedback.component';
import { FakeListItemDirective } from '../utils/fake-list-item.directive';
import { GroupListToolbarComponent } from '../utils/group-list-toolbar/group-list-toolbar.component';
import { NgTemplateOutlet, NgClass, AsyncPipe } from '@angular/common';
import { MatProgressBar } from '@angular/material/progress-bar';
import * as i0 from "@angular/core";
import * as i1 from "../../../service/sii-list-controller.service";
export class GroupedInfiniteScrollComponent {
    constructor(el, siiListController, changeDetector) {
        this.el = el;
        this.siiListController = siiListController;
        this.changeDetector = changeDetector;
        this.multiselect = false;
        this.selectable = true;
        this.selectOnlyWithHandler = false; //la selezione singola o multipla avviene sollo dal sii-list-multiselect-handler
        this.itemClick = new EventEmitter();
        this.subscription = new Subscription();
        this.utils = {
            lastContentWidth: 0,
            hideNotVisibleRowObserver: new Subject(),
            resizeObserver: new Subject()
        };
        this.ds = new SiiGroupedInfiniteScrollDataSource(this.siiListController, this.changeDetector);
        // // lastScrollHeight=0;
        // public get scrollerEl():HTMLElement{
        //   return this.scrolleRef.nativeElement;
        // }
        this.scrollerEl = document;
        this.scrollerFunctionRef = (event) => {
            this.utils.hideNotVisibleRowObserver.next();
            if (event.target === event.currentTarget && !this.siiListController.fetchInProgress.value && this.isScrolledAtEndOfPage()) {
                //  console.log(` distance from bottom ${document.body.offsetHeight - Math.ceil(window.innerHeight + window.scrollY)}
                //  -> condition to fetch -> ${Math.ceil(window.innerHeight + window.scrollY) >= document.body.offsetHeight}`);
                //  condition to fetch -> ${Math.ceil(window.innerHeight + window.scrollY) >= document.body.offsetHeight}`);
                this.ds.fetchNextPage();
            }
        };
        this.clickedOnMultiselectHandler = (ev) => {
            return ev.target.closest('[sii-list-multiselect-handler]') !== null;
        };
        this.subscription.add(this.utils.hideNotVisibleRowObserver.pipe(debounceTime(100)).subscribe(() => this.hideNotVisibleRow()));
        this.subscription.add(this.utils.resizeObserver.pipe(debounceTime(100)).subscribe(() => {
            this.hideNotVisibleRow(true);
            this.checkForAvailableSpaceAfterResize();
        }));
        this.containerObserver = new ResizeObserver(entries => {
            if (entries[0].contentRect.width !== this.utils.lastContentWidth) {
                this.utils.lastContentWidth = entries[0].contentRect.width;
                this.utils.resizeObserver.next();
            }
        });
        this.subscription.add(siiListController.fetchPageData.subscribe((resp) => {
            if (resp.reset) {
                this.scrollerEl.scrollingElement.scrollTo({ top: 0 });
                // this.lastScrollHeight=0;
            }
            setTimeout(() => {
                // console.log(`infinitescroll fetchPageData
                // this.scrollerEl.offsetHeight===this.scrollerEl.scrollHeight=${this.scrollerEl.offsetHeight===this.scrollerEl.scrollHeight}
                // || this.lastScrollHeight(${this.lastScrollHeight})===this.scrollerEl.scrollHeight ${this.scrollerEl.scrollHeight} = ${this.lastScrollHeight===this.scrollerEl.scrollHeight}
                // &&resp.rows.maxPage>resp.rows.currPage= ${resp.rows.maxPage>resp.rows.currPage}`)
                if ((window.scrollY >= document.body.offsetHeight // scroll not visible
                    || this.isScrolledAtEndOfPage()
                // || this.lastScrollHeight===this.scrollerEl.scrollHeight     // l'ultima posizione non è variata
                ) && resp.rows.maxPage > resp.rows.currPage) {
                    // console.log('fetchBy setTimeout');
                    this.ds.fetchNextPage();
                    // this.lastScrollHeight=this.scrollerEl.scrollHeight;
                }
            }, 1000);
        }));
    }
    ngAfterViewInit() {
        this.containerObserver.observe(this.listContainer.nativeElement);
        // lancio la ricerca
        Promise.resolve().then(() => this.ds.fetchNextPage());
        this.scrollerEl.addEventListener('scroll', this.scrollerFunctionRef, { capture: true, passive: true });
    }
    isScrolledAtEndOfPage() {
        // aggiungo 2 px di margine
        return Math.round(window.innerHeight + window.scrollY + 2) >= document.body.offsetHeight;
    }
    hideNotVisibleRow(refresh = false) {
        this.listRows.forEach((i) => { i.check(refresh); });
        if (refresh) {
            this.utils.hideNotVisibleRowObserver.next();
        }
    }
    ngOnDestroy() {
        this.containerObserver.unobserve(this.listContainer.nativeElement);
        this.subscription.unsubscribe();
        if (this.widthWatchInterval) {
            clearInterval(this.widthWatchInterval);
        }
        this.scrollerEl.removeEventListener('scroll', this.scrollerFunctionRef, true);
    }
    itemClicked(item, ev) {
        this.itemClick.next(item);
        if (this.selectable) {
            if (this.multiselect && this.clickedOnMultiselectHandler(ev)) {
                this.siiListController.multiselectItemClick(item);
            }
            else {
                if (!this.selectOnlyWithHandler) {
                    this.siiListController.singleselectItemClick(item);
                }
            }
        }
    }
    checkForAvailableSpaceAfterResize() {
        if ((window.scrollY >= document.body.offsetHeight // scroll not visible
            || this.isScrolledAtEndOfPage() // i'm at the end of the page
        )
            && !this.siiListController.fetchInProgress.value
            //  && this.scrollerEl.scrollHeight!==this.lastScrollHeight
            && this.siiListController.lastFetchRequestInfo !== undefined
            && this.siiListController.lastFetchRequestInfo.maxPage > this.siiListController.lastFetchRequestInfo.currPage) {
            // console.log(`infiniteScroll. fetch page`)
            // console.log('fetchBy resize');
            this.ds.fetchNextPage();
            // this.lastScrollHeight=this.scrollerEl.scrollHeight;
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: GroupedInfiniteScrollComponent, deps: [{ token: i0.ElementRef }, { token: i1.SiiListController }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "18.2.13", type: GroupedInfiniteScrollComponent, isStandalone: true, selector: "sii-grouped-infinite-scroll", inputs: { multiselect: "multiselect", selectable: "selectable", selectOnlyWithHandler: "selectOnlyWithHandler", groupListToolbarClass: "groupListToolbarClass" }, outputs: { itemClick: "itemClick" }, queries: [{ propertyName: "templateRef", first: true, predicate: ListRowDirective, descendants: true, read: TemplateRef }, { propertyName: "noDataFoundTpl", first: true, predicate: EmptyListMessageDirective, descendants: true, read: TemplateRef }], viewQueries: [{ propertyName: "listContainer", first: true, predicate: ["vs_ref"], descendants: true }, { propertyName: "listRows", predicate: AutoHideRowDirective, descendants: true }], ngImport: i0, template: "<!-- <mat-progress-bar mode=\"query\" ></mat-progress-bar> -->\r\n@if (siiListController.fetchInProgressObs | async) {\r\n  <mat-progress-bar mode=\"query\"></mat-progress-bar>\r\n}\r\n\r\n<div class=\"infiniteScrollListContainer\" #vs_ref  >\r\n  <ng-content select=\"[listHeader]\"></ng-content>\r\n\r\n  @if (ds.listSize==0 && !(siiListController.fetchInProgressObs | async)) {\r\n    <div class=\"emptyListContainer\">\r\n      <ng-container  *ngTemplateOutlet=\"noDataFoundTpl || defaultEmptyData\" ></ng-container>\r\n    </div>\r\n  }\r\n\r\n  <!-- <div  [@fadeInOut]  style=\"width: 200px;height: 200px; background-color: red;\" *ngIf=\"vv\"></div> -->\r\n\r\n  @if (ds.displayedListSize==0 &&   ds.visibleGroups[0]!=undefined ) {\r\n    @for (gr of ds.visibleGroups[0]; track gr.key) {\r\n      <sii-group-list-toolbar [ngClass]=\"groupListToolbarClass\" [group]=\"gr\" [ds]=\"ds\"></sii-group-list-toolbar>\r\n    }\r\n  }\r\n\r\n\r\n  @for (item of ds.data | async  ; track item['_siiId']; let index = $index; let last = $last) {\r\n    @if (ds.visibleGroups[index] && (index!=0 || ds.visibleGroups[0][0].key!='##NOGROUP##' )) {\r\n      @for (gr of ds.visibleGroups[index]; track gr.key) {\r\n        <sii-group-list-toolbar [ngClass]=\"groupListToolbarClass\"  [group]=\"gr\" [ds]=\"ds\"></sii-group-list-toolbar>\r\n      }\r\n    }\r\n    <!-- siiFakeListItem [@fadeIn]-->\r\n    @if (item) {\r\n      <span *siiAutoHideRow=\"'AAR'+index\"  class=\"siiAutoHide\">\r\n        <div #itemRef  class=\"infiniteScrollItem\" [class.sii-infinite-scroll-selected]=\"item && siiListController.isSelected(item)\" (click)=\"itemClicked(item,$event)\">\r\n          <ng-container   *ngTemplateOutlet=\"templateRef; context:{$implicit:item, index:index, items:ds.dataValue,\r\n              prev: (index==0?null : ds.dataValue[index-1]),\r\n              next:(last?null:ds.dataValue[index+1]),\r\n              group: ds.bySiiId[item['_siiId']]   } \" ></ng-container>\r\n        </div>\r\n        @if (last || ds.visibleGroups[index+1]) {\r\n          <span  *siiFakeListItem=\"itemRef;\"></span>\r\n        }\r\n      </span>\r\n    }\r\n  }\r\n\r\n  @if (ds.displayedListSize>0 &&   ds.visibleGroups[ds.displayedListSize]!=undefined ) {\r\n    @for (gr of ds.visibleGroups[ds.displayedListSize]; track gr.key) {\r\n      <sii-group-list-toolbar [ngClass]=\"groupListToolbarClass\" [group]=\"gr\" [ds]=\"ds\"></sii-group-list-toolbar>\r\n    }\r\n  }\r\n\r\n  <ng-content select=\"[listFooter]\"></ng-content>\r\n</div>\r\n\r\n\r\n<ng-template #defaultEmptyData>\r\n  <sii-banner-feedback type='info' style=\"flex:1\" >\r\n    <div feedback-toolbar>No Data Found</div>\r\n  </sii-banner-feedback>\r\n</ng-template>\r\n", styles: [":host{display:flex;min-height:200px;width:100%;position:relative}.infiniteScrollListContainer{width:100%;display:flex;flex-direction:row;flex-wrap:wrap;justify-content:space-around;align-items:flex-start;align-content:flex-start}mat-progress-bar{position:fixed;z-index:3;top:calc(var(--toolbarHeight) + var(--pageContentToolbarsContainerHeight) + var(--pageContainerToolbarHeight))}.emptyListContainer{display:flex;padding:10px;width:100%;box-sizing:border-box}.cis_group_toolbar{display:flex}.infiniteScrollItem,.siiAutoHide{display:contents}sii-group-list-toolbar{position:sticky;top:calc(var(--toolbarHeight) + var(--pageContentToolbarsContainerHeight) + var(--pageContainerToolbarHeight) + var(--prevGroupParent));background-image:var(--bgImageUrl);background-size:cover;background-repeat:no-repeat;background-image:linear-gradient(-186.39deg,#090909 -7.89%,#161721 26.77%,#000 59.41%,#323551 94.42%);background-attachment:fixed;z-index:2}\n"], dependencies: [{ kind: "component", type: MatProgressBar, selector: "mat-progress-bar", inputs: ["color", "value", "bufferValue", "mode"], outputs: ["animationEnd"], exportAs: ["matProgressBar"] }, { kind: "directive", type: NgTemplateOutlet, selector: "[ngTemplateOutlet]", inputs: ["ngTemplateOutletContext", "ngTemplateOutlet", "ngTemplateOutletInjector"] }, { kind: "component", type: GroupListToolbarComponent, selector: "sii-group-list-toolbar", inputs: ["ds", "group"] }, { kind: "directive", type: NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: AutoHideRowDirective, selector: "[siiAutoHideRow]", inputs: ["siiAutoHideRow"] }, { kind: "directive", type: FakeListItemDirective, selector: "[siiFakeListItem]", inputs: ["siiFakeListItem"] }, { kind: "component", type: BannerFeedbackComponent, selector: "sii-banner-feedback", inputs: ["type"] }, { kind: "pipe", type: AsyncPipe, name: "async" }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: GroupedInfiniteScrollComponent, decorators: [{
            type: Component,
            args: [{ selector: 'sii-grouped-infinite-scroll', standalone: true, imports: [
                        MatProgressBar,
                        NgTemplateOutlet,
                        GroupListToolbarComponent,
                        NgClass,
                        AutoHideRowDirective,
                        FakeListItemDirective,
                        BannerFeedbackComponent,
                        AsyncPipe,
                    ], template: "<!-- <mat-progress-bar mode=\"query\" ></mat-progress-bar> -->\r\n@if (siiListController.fetchInProgressObs | async) {\r\n  <mat-progress-bar mode=\"query\"></mat-progress-bar>\r\n}\r\n\r\n<div class=\"infiniteScrollListContainer\" #vs_ref  >\r\n  <ng-content select=\"[listHeader]\"></ng-content>\r\n\r\n  @if (ds.listSize==0 && !(siiListController.fetchInProgressObs | async)) {\r\n    <div class=\"emptyListContainer\">\r\n      <ng-container  *ngTemplateOutlet=\"noDataFoundTpl || defaultEmptyData\" ></ng-container>\r\n    </div>\r\n  }\r\n\r\n  <!-- <div  [@fadeInOut]  style=\"width: 200px;height: 200px; background-color: red;\" *ngIf=\"vv\"></div> -->\r\n\r\n  @if (ds.displayedListSize==0 &&   ds.visibleGroups[0]!=undefined ) {\r\n    @for (gr of ds.visibleGroups[0]; track gr.key) {\r\n      <sii-group-list-toolbar [ngClass]=\"groupListToolbarClass\" [group]=\"gr\" [ds]=\"ds\"></sii-group-list-toolbar>\r\n    }\r\n  }\r\n\r\n\r\n  @for (item of ds.data | async  ; track item['_siiId']; let index = $index; let last = $last) {\r\n    @if (ds.visibleGroups[index] && (index!=0 || ds.visibleGroups[0][0].key!='##NOGROUP##' )) {\r\n      @for (gr of ds.visibleGroups[index]; track gr.key) {\r\n        <sii-group-list-toolbar [ngClass]=\"groupListToolbarClass\"  [group]=\"gr\" [ds]=\"ds\"></sii-group-list-toolbar>\r\n      }\r\n    }\r\n    <!-- siiFakeListItem [@fadeIn]-->\r\n    @if (item) {\r\n      <span *siiAutoHideRow=\"'AAR'+index\"  class=\"siiAutoHide\">\r\n        <div #itemRef  class=\"infiniteScrollItem\" [class.sii-infinite-scroll-selected]=\"item && siiListController.isSelected(item)\" (click)=\"itemClicked(item,$event)\">\r\n          <ng-container   *ngTemplateOutlet=\"templateRef; context:{$implicit:item, index:index, items:ds.dataValue,\r\n              prev: (index==0?null : ds.dataValue[index-1]),\r\n              next:(last?null:ds.dataValue[index+1]),\r\n              group: ds.bySiiId[item['_siiId']]   } \" ></ng-container>\r\n        </div>\r\n        @if (last || ds.visibleGroups[index+1]) {\r\n          <span  *siiFakeListItem=\"itemRef;\"></span>\r\n        }\r\n      </span>\r\n    }\r\n  }\r\n\r\n  @if (ds.displayedListSize>0 &&   ds.visibleGroups[ds.displayedListSize]!=undefined ) {\r\n    @for (gr of ds.visibleGroups[ds.displayedListSize]; track gr.key) {\r\n      <sii-group-list-toolbar [ngClass]=\"groupListToolbarClass\" [group]=\"gr\" [ds]=\"ds\"></sii-group-list-toolbar>\r\n    }\r\n  }\r\n\r\n  <ng-content select=\"[listFooter]\"></ng-content>\r\n</div>\r\n\r\n\r\n<ng-template #defaultEmptyData>\r\n  <sii-banner-feedback type='info' style=\"flex:1\" >\r\n    <div feedback-toolbar>No Data Found</div>\r\n  </sii-banner-feedback>\r\n</ng-template>\r\n", styles: [":host{display:flex;min-height:200px;width:100%;position:relative}.infiniteScrollListContainer{width:100%;display:flex;flex-direction:row;flex-wrap:wrap;justify-content:space-around;align-items:flex-start;align-content:flex-start}mat-progress-bar{position:fixed;z-index:3;top:calc(var(--toolbarHeight) + var(--pageContentToolbarsContainerHeight) + var(--pageContainerToolbarHeight))}.emptyListContainer{display:flex;padding:10px;width:100%;box-sizing:border-box}.cis_group_toolbar{display:flex}.infiniteScrollItem,.siiAutoHide{display:contents}sii-group-list-toolbar{position:sticky;top:calc(var(--toolbarHeight) + var(--pageContentToolbarsContainerHeight) + var(--pageContainerToolbarHeight) + var(--prevGroupParent));background-image:var(--bgImageUrl);background-size:cover;background-repeat:no-repeat;background-image:linear-gradient(-186.39deg,#090909 -7.89%,#161721 26.77%,#000 59.41%,#323551 94.42%);background-attachment:fixed;z-index:2}\n"] }]
        }], ctorParameters: () => [{ type: i0.ElementRef }, { type: i1.SiiListController }, { type: i0.ChangeDetectorRef }], propDecorators: { templateRef: [{
                type: ContentChild,
                args: [ListRowDirective, { read: TemplateRef }]
            }], listRows: [{
                type: ViewChildren,
                args: [AutoHideRowDirective]
            }], noDataFoundTpl: [{
                type: ContentChild,
                args: [EmptyListMessageDirective, { read: TemplateRef }]
            }], multiselect: [{
                type: Input
            }], selectable: [{
                type: Input
            }], selectOnlyWithHandler: [{
                type: Input
            }], groupListToolbarClass: [{
                type: Input
            }], itemClick: [{
                type: Output
            }], listContainer: [{
                type: ViewChild,
                args: ['vs_ref']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JvdXBlZC1pbmZpbml0ZS1zY3JvbGwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2lpLXRvb2xraXQvc3JjL2xpYi9jb21wb25lbnRzL2xpc3QvZ3JvdXBlZC1pbmZpbml0ZS1zY3JvbGwvZ3JvdXBlZC1pbmZpbml0ZS1zY3JvbGwuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2lpLXRvb2xraXQvc3JjL2xpYi9jb21wb25lbnRzL2xpc3QvZ3JvdXBlZC1pbmZpbml0ZS1zY3JvbGwvZ3JvdXBlZC1pbmZpbml0ZS1zY3JvbGwuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBeUIsTUFBTSxFQUFFLFlBQVksRUFBaUIsWUFBWSxFQUE4QixZQUFZLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQ2hOLE9BQU8sRUFBRyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRzlDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDBEQUEwRCxDQUFDO0FBQ3JHLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBRXJHLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdEQUFnRCxDQUFDO0FBQ3RGLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwwREFBMEQsQ0FBQztBQUNuRyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUMxRSxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwwREFBMEQsQ0FBQztBQUNyRyxP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RHRDUSxjQUFjLHlLQUNkLGdCQUFnQixvSkFDaEIseUJBQXlCLDRGQUN6QixPQUFPLG9GQUNQLG9CQUFvQix5RkFDcEIscUJBQXFCLDJGQUNyQix1QkFBdUIsNkVBQ3ZCLFNBQVM7OzRGQUdKLDhCQUE4QjtrQkFoQjFDLFNBQVM7K0JBQ0ksNkJBQTZCLGNBRzNCLElBQUksV0FDUDt3QkFDTCxjQUFjO3dCQUNkLGdCQUFnQjt3QkFDaEIseUJBQXlCO3dCQUN6QixPQUFPO3dCQUNQLG9CQUFvQjt3QkFDcEIscUJBQXFCO3dCQUNyQix1QkFBdUI7d0JBQ3ZCLFNBQVM7cUJBQ1o7K0lBR2tELFdBQVc7c0JBQS9ELFlBQVk7dUJBQUMsZ0JBQWdCLEVBQUUsRUFBQyxJQUFJLEVBQUUsV0FBVyxFQUFDO2dCQUVmLFFBQVE7c0JBQTNDLFlBQVk7dUJBQUMsb0JBQW9CO2dCQUM0QixjQUFjO3NCQUEzRSxZQUFZO3VCQUFDLHlCQUF5QixFQUFFLEVBQUMsSUFBSSxFQUFFLFdBQVcsRUFBQztnQkFDbkQsV0FBVztzQkFBbkIsS0FBSztnQkFDRyxVQUFVO3NCQUFsQixLQUFLO2dCQUNHLHFCQUFxQjtzQkFBN0IsS0FBSztnQkFDRyxxQkFBcUI7c0JBQTdCLEtBQUs7Z0JBQ0ksU0FBUztzQkFBbEIsTUFBTTtnQkFZYyxhQUFhO3NCQUFqQyxTQUFTO3VCQUFDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBWaWV3Q2hpbGQsIFRlbXBsYXRlUmVmLCBFbGVtZW50UmVmLCBPbkRlc3Ryb3ksIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBBZnRlclZpZXdJbml0LCBDb250ZW50Q2hpbGQsIENvbnRlbnRDaGlsZHJlbiwgUXVlcnlMaXN0LCBWaWV3Q2hpbGRyZW4sIENoYW5nZURldGVjdG9yUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7ICBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgU2lpTGlzdENvbnRyb2xsZXIgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlL3NpaS1saXN0LWNvbnRyb2xsZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IFNjcm9sbGVyQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vcGFnZS1jb250YWluZXIvdXRpbHMvZHRvL3Njcm9sbGVyLWNvbXBvbmVudC5kdG8nO1xyXG5pbXBvcnQgeyBMaXN0Um93RGlyZWN0aXZlIH0gZnJvbSAnLi4vdXRpbHMvbGlzdC1yb3cvbGlzdC1yb3cuZGlyZWN0aXZlJztcclxuaW1wb3J0IHsgRW1wdHlMaXN0TWVzc2FnZURpcmVjdGl2ZSB9IGZyb20gJy4uL3V0aWxzL2VtcHR5LWxpc3QtbWVzc2FnZS9lbXB0eS1saXN0LW1lc3NhZ2UuZGlyZWN0aXZlJztcclxuaW1wb3J0IHsgU2lpR3JvdXBlZEluZmluaXRlU2Nyb2xsRGF0YVNvdXJjZSB9IGZyb20gJy4vdXRpbHMvc2lpLWdyb3VwZWQtaW5maW5pdGUtc2Nyb2xsLWRhdGEtc291cmNlJztcclxuaW1wb3J0IHtzdHlsZSwgIGFuaW1hdGUsIHRyYW5zaXRpb24sIHRyaWdnZXJ9IGZyb20gJ0Bhbmd1bGFyL2FuaW1hdGlvbnMnO1xyXG5pbXBvcnQgeyBBdXRvSGlkZVJvd0RpcmVjdGl2ZSB9IGZyb20gJy4uL3V0aWxzL2F1dG8taGlkZS1yb3cvYXV0by1oaWRlLXJvdy5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEJhbm5lckZlZWRiYWNrQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZmVlZGJhY2svYmFubmVyLWZlZWRiYWNrL2Jhbm5lci1mZWVkYmFjay5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBGYWtlTGlzdEl0ZW1EaXJlY3RpdmUgfSBmcm9tICcuLi91dGlscy9mYWtlLWxpc3QtaXRlbS5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBHcm91cExpc3RUb29sYmFyQ29tcG9uZW50IH0gZnJvbSAnLi4vdXRpbHMvZ3JvdXAtbGlzdC10b29sYmFyL2dyb3VwLWxpc3QtdG9vbGJhci5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBOZ1RlbXBsYXRlT3V0bGV0LCBOZ0NsYXNzLCBBc3luY1BpcGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQgeyBNYXRQcm9ncmVzc0JhciB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL3Byb2dyZXNzLWJhcic7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnc2lpLWdyb3VwZWQtaW5maW5pdGUtc2Nyb2xsJyxcclxuICAgIHRlbXBsYXRlVXJsOiAnLi9ncm91cGVkLWluZmluaXRlLXNjcm9sbC5jb21wb25lbnQuaHRtbCcsXHJcbiAgICBzdHlsZVVybHM6IFsnLi9ncm91cGVkLWluZmluaXRlLXNjcm9sbC5jb21wb25lbnQuY3NzJ10sXHJcbiAgICBzdGFuZGFsb25lOiB0cnVlLFxyXG4gICAgaW1wb3J0czogW1xyXG4gICAgICAgIE1hdFByb2dyZXNzQmFyLFxyXG4gICAgICAgIE5nVGVtcGxhdGVPdXRsZXQsXHJcbiAgICAgICAgR3JvdXBMaXN0VG9vbGJhckNvbXBvbmVudCxcclxuICAgICAgICBOZ0NsYXNzLFxyXG4gICAgICAgIEF1dG9IaWRlUm93RGlyZWN0aXZlLFxyXG4gICAgICAgIEZha2VMaXN0SXRlbURpcmVjdGl2ZSxcclxuICAgICAgICBCYW5uZXJGZWVkYmFja0NvbXBvbmVudCxcclxuICAgICAgICBBc3luY1BpcGUsXHJcbiAgICBdLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgR3JvdXBlZEluZmluaXRlU2Nyb2xsQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95LCBTY3JvbGxlckNvbXBvbmVudHtcclxuICBAQ29udGVudENoaWxkKExpc3RSb3dEaXJlY3RpdmUsIHtyZWFkOiBUZW1wbGF0ZVJlZn0pIHRlbXBsYXRlUmVmO1xyXG4gIC8vIEBWaWV3Q2hpbGRyZW4oJ2l0ZW1SZWYnKSBsaXN0Um93czI6IFF1ZXJ5TGlzdDxhbnk+O1xyXG4gIEBWaWV3Q2hpbGRyZW4oQXV0b0hpZGVSb3dEaXJlY3RpdmUpIGxpc3RSb3dzOiBRdWVyeUxpc3Q8QXV0b0hpZGVSb3dEaXJlY3RpdmU+O1xyXG4gIEBDb250ZW50Q2hpbGQoRW1wdHlMaXN0TWVzc2FnZURpcmVjdGl2ZSwge3JlYWQ6IFRlbXBsYXRlUmVmfSkgbm9EYXRhRm91bmRUcGw7XHJcbiAgQElucHV0KCkgbXVsdGlzZWxlY3QgPSBmYWxzZTtcclxuICBASW5wdXQoKSBzZWxlY3RhYmxlID0gdHJ1ZTtcclxuICBASW5wdXQoKSBzZWxlY3RPbmx5V2l0aEhhbmRsZXIgPSBmYWxzZTsgLy9sYSBzZWxlemlvbmUgc2luZ29sYSBvIG11bHRpcGxhIGF2dmllbmUgc29sbG8gZGFsIHNpaS1saXN0LW11bHRpc2VsZWN0LWhhbmRsZXJcclxuICBASW5wdXQoKSBncm91cExpc3RUb29sYmFyQ2xhc3M6IGFueTtcclxuICBAT3V0cHV0KCkgaXRlbUNsaWNrID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xyXG4gIHdpZHRoV2F0Y2hJbnRlcnZhbDtcclxuICB1dGlscyA9IHtcclxuICAgIGxhc3RDb250ZW50V2lkdGg6IDAsXHJcbiAgICBoaWRlTm90VmlzaWJsZVJvd09ic2VydmVyOiBuZXcgU3ViamVjdDx2b2lkPigpLFxyXG4gICAgcmVzaXplT2JzZXJ2ZXI6IG5ldyBTdWJqZWN0PHZvaWQ+KClcclxuICB9O1xyXG5cclxuICBkcyA9IG5ldyBTaWlHcm91cGVkSW5maW5pdGVTY3JvbGxEYXRhU291cmNlKHRoaXMuc2lpTGlzdENvbnRyb2xsZXIsIHRoaXMuY2hhbmdlRGV0ZWN0b3IpO1xyXG5cclxuICBAVmlld0NoaWxkKCd2c19yZWYnKSBsaXN0Q29udGFpbmVyOiBFbGVtZW50UmVmO1xyXG4gIGNvbnRhaW5lck9ic2VydmVyO1xyXG4gIC8vIC8vIGxhc3RTY3JvbGxIZWlnaHQ9MDtcclxuXHJcbiAgLy8gcHVibGljIGdldCBzY3JvbGxlckVsKCk6SFRNTEVsZW1lbnR7XHJcbiAgLy8gICByZXR1cm4gdGhpcy5zY3JvbGxlUmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgLy8gfVxyXG4gIHB1YmxpYyBzY3JvbGxlckVsID0gZG9jdW1lbnQ7XHJcblxyXG5cclxuICBjb25zdHJ1Y3RvcihwdWJsaWMgIGVsOiBFbGVtZW50UmVmLCBwdWJsaWMgc2lpTGlzdENvbnRyb2xsZXI6IFNpaUxpc3RDb250cm9sbGVyLCBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZil7XHJcblxyXG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKHRoaXMudXRpbHMuaGlkZU5vdFZpc2libGVSb3dPYnNlcnZlci5waXBlKGRlYm91bmNlVGltZSgxMDApKS5zdWJzY3JpYmUoKCkgPT4gdGhpcy5oaWRlTm90VmlzaWJsZVJvdygpKSk7XHJcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQodGhpcy51dGlscy5yZXNpemVPYnNlcnZlci5waXBlKGRlYm91bmNlVGltZSgxMDApKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLmhpZGVOb3RWaXNpYmxlUm93KHRydWUpO1xyXG4gICAgICB0aGlzLmNoZWNrRm9yQXZhaWxhYmxlU3BhY2VBZnRlclJlc2l6ZSgpO1xyXG4gICAgfSkpO1xyXG5cclxuICAgIHRoaXMuY29udGFpbmVyT2JzZXJ2ZXIgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoZW50cmllcyA9PiB7XHJcbiAgICAgICAgICBpZiAoZW50cmllc1swXS5jb250ZW50UmVjdC53aWR0aCAhPT0gdGhpcy51dGlscy5sYXN0Q29udGVudFdpZHRoKXtcclxuICAgICAgICAgICAgdGhpcy51dGlscy5sYXN0Q29udGVudFdpZHRoID0gZW50cmllc1swXS5jb250ZW50UmVjdC53aWR0aDtcclxuICAgICAgICAgICAgdGhpcy51dGlscy5yZXNpemVPYnNlcnZlci5uZXh0KCk7XHJcbiAgICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcblxyXG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKHNpaUxpc3RDb250cm9sbGVyLmZldGNoUGFnZURhdGEuc3Vic2NyaWJlKChyZXNwKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3AucmVzZXQpe1xyXG4gICAgICAgICAgdGhpcy5zY3JvbGxlckVsLnNjcm9sbGluZ0VsZW1lbnQuc2Nyb2xsVG8oe3RvcDogMH0pO1xyXG4gICAgICAgICAgLy8gdGhpcy5sYXN0U2Nyb2xsSGVpZ2h0PTA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coYGluZmluaXRlc2Nyb2xsIGZldGNoUGFnZURhdGFcclxuICAgICAgICAgIC8vIHRoaXMuc2Nyb2xsZXJFbC5vZmZzZXRIZWlnaHQ9PT10aGlzLnNjcm9sbGVyRWwuc2Nyb2xsSGVpZ2h0PSR7dGhpcy5zY3JvbGxlckVsLm9mZnNldEhlaWdodD09PXRoaXMuc2Nyb2xsZXJFbC5zY3JvbGxIZWlnaHR9XHJcbiAgICAgICAgICAvLyB8fCB0aGlzLmxhc3RTY3JvbGxIZWlnaHQoJHt0aGlzLmxhc3RTY3JvbGxIZWlnaHR9KT09PXRoaXMuc2Nyb2xsZXJFbC5zY3JvbGxIZWlnaHQgJHt0aGlzLnNjcm9sbGVyRWwuc2Nyb2xsSGVpZ2h0fSA9ICR7dGhpcy5sYXN0U2Nyb2xsSGVpZ2h0PT09dGhpcy5zY3JvbGxlckVsLnNjcm9sbEhlaWdodH1cclxuICAgICAgICAgIC8vICYmcmVzcC5yb3dzLm1heFBhZ2U+cmVzcC5yb3dzLmN1cnJQYWdlPSAke3Jlc3Aucm93cy5tYXhQYWdlPnJlc3Aucm93cy5jdXJyUGFnZX1gKVxyXG4gICAgICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgICAgICAoXHJcbiAgICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxZID49IGRvY3VtZW50LmJvZHkub2Zmc2V0SGVpZ2h0IC8vIHNjcm9sbCBub3QgdmlzaWJsZVxyXG4gICAgICAgICAgICAgICAgICB8fCB0aGlzLmlzU2Nyb2xsZWRBdEVuZE9mUGFnZSgpXHJcbiAgICAgICAgICAgICAgICAgIC8vIHx8IHRoaXMubGFzdFNjcm9sbEhlaWdodD09PXRoaXMuc2Nyb2xsZXJFbC5zY3JvbGxIZWlnaHQgICAgIC8vIGwndWx0aW1hIHBvc2l6aW9uZSBub24gw6ggdmFyaWF0YVxyXG4gICAgICAgICAgICAgICkgJiYgcmVzcC5yb3dzLm1heFBhZ2UgPiByZXNwLnJvd3MuY3VyclBhZ2Upe1xyXG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2ZldGNoQnkgc2V0VGltZW91dCcpO1xyXG4gICAgICAgICAgICAgIHRoaXMuZHMuZmV0Y2hOZXh0UGFnZSgpO1xyXG4gICAgICAgICAgICAgIC8vIHRoaXMubGFzdFNjcm9sbEhlaWdodD10aGlzLnNjcm9sbGVyRWwuc2Nyb2xsSGVpZ2h0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9LCAxMDAwKTtcclxuICAgICAgfVxyXG4gICAgICApXHJcbiAgICAgKTtcclxuXHJcbiAgfVxyXG5cclxuXHJcbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG5cclxuICAgIHRoaXMuY29udGFpbmVyT2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLmxpc3RDb250YWluZXIubmF0aXZlRWxlbWVudCk7XHJcblxyXG4gICAgLy8gbGFuY2lvIGxhIHJpY2VyY2FcclxuICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gICAgdGhpcy5kcy5mZXRjaE5leHRQYWdlKCkpO1xyXG5cclxuICAgIHRoaXMuc2Nyb2xsZXJFbC5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLnNjcm9sbGVyRnVuY3Rpb25SZWYsIHtjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlfSk7XHJcbiAgfVxyXG5cclxuICBzY3JvbGxlckZ1bmN0aW9uUmVmID0gKGV2ZW50OiBFdmVudCkgPT4ge1xyXG5cclxuICAgICAgdGhpcy51dGlscy5oaWRlTm90VmlzaWJsZVJvd09ic2VydmVyLm5leHQoKTtcclxuICAgICAgaWYgKGV2ZW50LnRhcmdldCA9PT0gZXZlbnQuY3VycmVudFRhcmdldCAmJiAgIXRoaXMuc2lpTGlzdENvbnRyb2xsZXIuZmV0Y2hJblByb2dyZXNzLnZhbHVlICYmICB0aGlzLmlzU2Nyb2xsZWRBdEVuZE9mUGFnZSgpKXtcclxuICAgICAgLy8gIGNvbnNvbGUubG9nKGAgZGlzdGFuY2UgZnJvbSBib3R0b20gJHtkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodCAtIE1hdGguY2VpbCh3aW5kb3cuaW5uZXJIZWlnaHQgKyB3aW5kb3cuc2Nyb2xsWSl9XHJcbiAgICAgIC8vICAtPiBjb25kaXRpb24gdG8gZmV0Y2ggLT4gJHtNYXRoLmNlaWwod2luZG93LmlubmVySGVpZ2h0ICsgd2luZG93LnNjcm9sbFkpID49IGRvY3VtZW50LmJvZHkub2Zmc2V0SGVpZ2h0fWApO1xyXG4gICAgICAvLyAgY29uZGl0aW9uIHRvIGZldGNoIC0+ICR7TWF0aC5jZWlsKHdpbmRvdy5pbm5lckhlaWdodCArIHdpbmRvdy5zY3JvbGxZKSA+PSBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodH1gKTtcclxuICAgICAgICAgIHRoaXMuZHMuZmV0Y2hOZXh0UGFnZSgpO1xyXG4gICAgICB9XHJcbiAgfVxyXG5cclxuICBpc1Njcm9sbGVkQXRFbmRPZlBhZ2UoKXtcclxuICAgIC8vIGFnZ2l1bmdvIDIgcHggZGkgbWFyZ2luZVxyXG4gICAgcmV0dXJuIE1hdGgucm91bmQod2luZG93LmlubmVySGVpZ2h0ICsgd2luZG93LnNjcm9sbFkgKyAyKSA+PSBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodDtcclxuICB9XHJcblxyXG4gIGhpZGVOb3RWaXNpYmxlUm93KHJlZnJlc2g9IGZhbHNlKXtcclxuICAgIHRoaXMubGlzdFJvd3MuZm9yRWFjaCgoaTogQXV0b0hpZGVSb3dEaXJlY3RpdmUpID0+IHsgaS5jaGVjayhyZWZyZXNoKTsgfSk7XHJcbiAgICBpZiAocmVmcmVzaCl7XHJcbiAgICAgIHRoaXMudXRpbHMuaGlkZU5vdFZpc2libGVSb3dPYnNlcnZlci5uZXh0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICB0aGlzLmNvbnRhaW5lck9ic2VydmVyLnVub2JzZXJ2ZSh0aGlzLmxpc3RDb250YWluZXIubmF0aXZlRWxlbWVudCk7XHJcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgaWYgKHRoaXMud2lkdGhXYXRjaEludGVydmFsKXtcclxuICAgICBjbGVhckludGVydmFsKHRoaXMud2lkdGhXYXRjaEludGVydmFsKTtcclxuICAgfVxyXG4gICAgdGhpcy5zY3JvbGxlckVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuc2Nyb2xsZXJGdW5jdGlvblJlZiwgdHJ1ZSk7XHJcbiAgfVxyXG5cclxuXHJcbiAgaXRlbUNsaWNrZWQoaXRlbSwgZXY6IE1vdXNlRXZlbnQpe1xyXG4gICAgdGhpcy5pdGVtQ2xpY2submV4dChpdGVtKTtcclxuICAgIGlmICh0aGlzLnNlbGVjdGFibGUpe1xyXG4gICAgICBpZiAodGhpcy5tdWx0aXNlbGVjdCAmJiB0aGlzLmNsaWNrZWRPbk11bHRpc2VsZWN0SGFuZGxlcihldikpe1xyXG4gICAgICAgIHRoaXMuc2lpTGlzdENvbnRyb2xsZXIubXVsdGlzZWxlY3RJdGVtQ2xpY2soaXRlbSk7XHJcbiAgICAgIH1lbHNle1xyXG4gICAgICAgIGlmKCF0aGlzLnNlbGVjdE9ubHlXaXRoSGFuZGxlcil7XHJcbiAgICAgICAgICB0aGlzLnNpaUxpc3RDb250cm9sbGVyLnNpbmdsZXNlbGVjdEl0ZW1DbGljayhpdGVtKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNsaWNrZWRPbk11bHRpc2VsZWN0SGFuZGxlciA9IChldikgPT4ge1xyXG4gICAgcmV0dXJuIGV2LnRhcmdldC5jbG9zZXN0KCdbc2lpLWxpc3QtbXVsdGlzZWxlY3QtaGFuZGxlcl0nKSAhPT0gbnVsbDtcclxuICB9XHJcblxyXG4gIGNoZWNrRm9yQXZhaWxhYmxlU3BhY2VBZnRlclJlc2l6ZSgpe1xyXG4gICAgICBpZiAoIChcclxuICAgICAgICB3aW5kb3cuc2Nyb2xsWSA+PSBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodCAvLyBzY3JvbGwgbm90IHZpc2libGVcclxuICAgICAgICB8fCB0aGlzLmlzU2Nyb2xsZWRBdEVuZE9mUGFnZSgpICAgICAgICAgICAgLy8gaSdtIGF0IHRoZSBlbmQgb2YgdGhlIHBhZ2VcclxuICAgICAgICApXHJcbiAgICAgICAgJiYgIXRoaXMuc2lpTGlzdENvbnRyb2xsZXIuZmV0Y2hJblByb2dyZXNzLnZhbHVlXHJcbiAgICAgICAgLy8gICYmIHRoaXMuc2Nyb2xsZXJFbC5zY3JvbGxIZWlnaHQhPT10aGlzLmxhc3RTY3JvbGxIZWlnaHRcclxuICAgICAgICAmJiB0aGlzLnNpaUxpc3RDb250cm9sbGVyLmxhc3RGZXRjaFJlcXVlc3RJbmZvICE9PSB1bmRlZmluZWRcclxuICAgICAgICAmJiB0aGlzLnNpaUxpc3RDb250cm9sbGVyLmxhc3RGZXRjaFJlcXVlc3RJbmZvLm1heFBhZ2UgPiB0aGlzLnNpaUxpc3RDb250cm9sbGVyLmxhc3RGZXRjaFJlcXVlc3RJbmZvLmN1cnJQYWdlKXtcclxuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBpbmZpbml0ZVNjcm9sbC4gZmV0Y2ggcGFnZWApXHJcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZygnZmV0Y2hCeSByZXNpemUnKTtcclxuICAgICAgICAgIHRoaXMuZHMuZmV0Y2hOZXh0UGFnZSgpO1xyXG4gICAgICAgICAgLy8gdGhpcy5sYXN0U2Nyb2xsSGVpZ2h0PXRoaXMuc2Nyb2xsZXJFbC5zY3JvbGxIZWlnaHQ7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4iLCI8IS0tIDxtYXQtcHJvZ3Jlc3MtYmFyIG1vZGU9XCJxdWVyeVwiID48L21hdC1wcm9ncmVzcy1iYXI+IC0tPlxyXG5AaWYgKHNpaUxpc3RDb250cm9sbGVyLmZldGNoSW5Qcm9ncmVzc09icyB8IGFzeW5jKSB7XHJcbiAgPG1hdC1wcm9ncmVzcy1iYXIgbW9kZT1cInF1ZXJ5XCI+PC9tYXQtcHJvZ3Jlc3MtYmFyPlxyXG59XHJcblxyXG48ZGl2IGNsYXNzPVwiaW5maW5pdGVTY3JvbGxMaXN0Q29udGFpbmVyXCIgI3ZzX3JlZiAgPlxyXG4gIDxuZy1jb250ZW50IHNlbGVjdD1cIltsaXN0SGVhZGVyXVwiPjwvbmctY29udGVudD5cclxuXHJcbiAgQGlmIChkcy5saXN0U2l6ZT09MCAmJiAhKHNpaUxpc3RDb250cm9sbGVyLmZldGNoSW5Qcm9ncmVzc09icyB8IGFzeW5jKSkge1xyXG4gICAgPGRpdiBjbGFzcz1cImVtcHR5TGlzdENvbnRhaW5lclwiPlxyXG4gICAgICA8bmctY29udGFpbmVyICAqbmdUZW1wbGF0ZU91dGxldD1cIm5vRGF0YUZvdW5kVHBsIHx8IGRlZmF1bHRFbXB0eURhdGFcIiA+PC9uZy1jb250YWluZXI+XHJcbiAgICA8L2Rpdj5cclxuICB9XHJcblxyXG4gIDwhLS0gPGRpdiAgW0BmYWRlSW5PdXRdICBzdHlsZT1cIndpZHRoOiAyMDBweDtoZWlnaHQ6IDIwMHB4OyBiYWNrZ3JvdW5kLWNvbG9yOiByZWQ7XCIgKm5nSWY9XCJ2dlwiPjwvZGl2PiAtLT5cclxuXHJcbiAgQGlmIChkcy5kaXNwbGF5ZWRMaXN0U2l6ZT09MCAmJiAgIGRzLnZpc2libGVHcm91cHNbMF0hPXVuZGVmaW5lZCApIHtcclxuICAgIEBmb3IgKGdyIG9mIGRzLnZpc2libGVHcm91cHNbMF07IHRyYWNrIGdyLmtleSkge1xyXG4gICAgICA8c2lpLWdyb3VwLWxpc3QtdG9vbGJhciBbbmdDbGFzc109XCJncm91cExpc3RUb29sYmFyQ2xhc3NcIiBbZ3JvdXBdPVwiZ3JcIiBbZHNdPVwiZHNcIj48L3NpaS1ncm91cC1saXN0LXRvb2xiYXI+XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgQGZvciAoaXRlbSBvZiBkcy5kYXRhIHwgYXN5bmMgIDsgdHJhY2sgaXRlbVsnX3NpaUlkJ107IGxldCBpbmRleCA9ICRpbmRleDsgbGV0IGxhc3QgPSAkbGFzdCkge1xyXG4gICAgQGlmIChkcy52aXNpYmxlR3JvdXBzW2luZGV4XSAmJiAoaW5kZXghPTAgfHwgZHMudmlzaWJsZUdyb3Vwc1swXVswXS5rZXkhPScjI05PR1JPVVAjIycgKSkge1xyXG4gICAgICBAZm9yIChnciBvZiBkcy52aXNpYmxlR3JvdXBzW2luZGV4XTsgdHJhY2sgZ3Iua2V5KSB7XHJcbiAgICAgICAgPHNpaS1ncm91cC1saXN0LXRvb2xiYXIgW25nQ2xhc3NdPVwiZ3JvdXBMaXN0VG9vbGJhckNsYXNzXCIgIFtncm91cF09XCJnclwiIFtkc109XCJkc1wiPjwvc2lpLWdyb3VwLWxpc3QtdG9vbGJhcj5cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgPCEtLSBzaWlGYWtlTGlzdEl0ZW0gW0BmYWRlSW5dLS0+XHJcbiAgICBAaWYgKGl0ZW0pIHtcclxuICAgICAgPHNwYW4gKnNpaUF1dG9IaWRlUm93PVwiJ0FBUicraW5kZXhcIiAgY2xhc3M9XCJzaWlBdXRvSGlkZVwiPlxyXG4gICAgICAgIDxkaXYgI2l0ZW1SZWYgIGNsYXNzPVwiaW5maW5pdGVTY3JvbGxJdGVtXCIgW2NsYXNzLnNpaS1pbmZpbml0ZS1zY3JvbGwtc2VsZWN0ZWRdPVwiaXRlbSAmJiBzaWlMaXN0Q29udHJvbGxlci5pc1NlbGVjdGVkKGl0ZW0pXCIgKGNsaWNrKT1cIml0ZW1DbGlja2VkKGl0ZW0sJGV2ZW50KVwiPlxyXG4gICAgICAgICAgPG5nLWNvbnRhaW5lciAgICpuZ1RlbXBsYXRlT3V0bGV0PVwidGVtcGxhdGVSZWY7IGNvbnRleHQ6eyRpbXBsaWNpdDppdGVtLCBpbmRleDppbmRleCwgaXRlbXM6ZHMuZGF0YVZhbHVlLFxyXG4gICAgICAgICAgICAgIHByZXY6IChpbmRleD09MD9udWxsIDogZHMuZGF0YVZhbHVlW2luZGV4LTFdKSxcclxuICAgICAgICAgICAgICBuZXh0OihsYXN0P251bGw6ZHMuZGF0YVZhbHVlW2luZGV4KzFdKSxcclxuICAgICAgICAgICAgICBncm91cDogZHMuYnlTaWlJZFtpdGVtWydfc2lpSWQnXV0gICB9IFwiID48L25nLWNvbnRhaW5lcj5cclxuICAgICAgICA8L2Rpdj5cclxuICAgICAgICBAaWYgKGxhc3QgfHwgZHMudmlzaWJsZUdyb3Vwc1tpbmRleCsxXSkge1xyXG4gICAgICAgICAgPHNwYW4gICpzaWlGYWtlTGlzdEl0ZW09XCJpdGVtUmVmO1wiPjwvc3Bhbj5cclxuICAgICAgICB9XHJcbiAgICAgIDwvc3Bhbj5cclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBpZiAoZHMuZGlzcGxheWVkTGlzdFNpemU+MCAmJiAgIGRzLnZpc2libGVHcm91cHNbZHMuZGlzcGxheWVkTGlzdFNpemVdIT11bmRlZmluZWQgKSB7XHJcbiAgICBAZm9yIChnciBvZiBkcy52aXNpYmxlR3JvdXBzW2RzLmRpc3BsYXllZExpc3RTaXplXTsgdHJhY2sgZ3Iua2V5KSB7XHJcbiAgICAgIDxzaWktZ3JvdXAtbGlzdC10b29sYmFyIFtuZ0NsYXNzXT1cImdyb3VwTGlzdFRvb2xiYXJDbGFzc1wiIFtncm91cF09XCJnclwiIFtkc109XCJkc1wiPjwvc2lpLWdyb3VwLWxpc3QtdG9vbGJhcj5cclxuICAgIH1cclxuICB9XHJcblxyXG4gIDxuZy1jb250ZW50IHNlbGVjdD1cIltsaXN0Rm9vdGVyXVwiPjwvbmctY29udGVudD5cclxuPC9kaXY+XHJcblxyXG5cclxuPG5nLXRlbXBsYXRlICNkZWZhdWx0RW1wdHlEYXRhPlxyXG4gIDxzaWktYmFubmVyLWZlZWRiYWNrIHR5cGU9J2luZm8nIHN0eWxlPVwiZmxleDoxXCIgPlxyXG4gICAgPGRpdiBmZWVkYmFjay10b29sYmFyPk5vIERhdGEgRm91bmQ8L2Rpdj5cclxuICA8L3NpaS1iYW5uZXItZmVlZGJhY2s+XHJcbjwvbmctdGVtcGxhdGU+XHJcbiJdfQ==