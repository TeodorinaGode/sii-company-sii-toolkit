import { Component, Input, TemplateRef, Output, EventEmitter, ContentChild } from '@angular/core';
import { Subscription } from 'rxjs';
import { SiiInfiniteScrollDataSource } from './utils/sii-infinite-scroll-data-source';
import { ListRowDirective } from '../utils/list-row/list-row.directive';
import { EmptyListMessageDirective } from '../utils/empty-list-message/empty-list-message.directive';
import { BannerFeedbackComponent } from '../../feedback/banner-feedback/banner-feedback.component';
import { NgTemplateOutlet, AsyncPipe } from '@angular/common';
import { MatProgressBar } from '@angular/material/progress-bar';
import * as i0 from "@angular/core";
import * as i1 from "../../../service/sii-list-controller.service";
export class InfiniteScrollComponent {
    constructor(el, siiListController) {
        this.el = el;
        this.siiListController = siiListController;
        this.multiselect = false;
        this.selectable = true;
        this.itemClick = new EventEmitter();
        this.initialized = false;
        this.subscription = new Subscription();
        this.ds = new SiiInfiniteScrollDataSource(this.siiListController);
        // @ViewChild('vs_ref') scrolleRef: ElementRef;
        // public get scrollerEl(): HTMLElement{
        //   return this.scrolleRef.nativeElement;
        // }
        this.scrollerEl = document;
        this.scrollerFunctionRef = (event) => {
            if (event.target === event.currentTarget && this.isScrolledAtEndOfPage()) {
                this.ds.fetchNextPage();
            }
        };
        this.clickedOnMultiselectHandler = (ev) => {
            return ev.target.closest('[sii-list-multiselect-handler]') !== null;
        };
        this.subscription.add(siiListController.fetchPageData.subscribe((resp) => {
            this.initialized = true;
            if (resp.reset) {
                this.scrollerEl.scrollingElement.scrollTo({ top: 0 });
            }
            setTimeout(() => {
                if ((window.scrollY >= document.body.offsetHeight // scroll not visible
                    || this.isScrolledAtEndOfPage()
                // || this.lastScrollHeight===this.scrollerEl.scrollHeight     // l'ultima posizione non è variata
                )
                    && resp.rows.maxPage > resp.rows.currPage) {
                    this.ds.fetchNextPage();
                }
            }, 0);
        }));
    }
    isScrolledAtEndOfPage() {
        return Math.round(window.innerHeight + window.scrollY) >= document.body.offsetHeight;
    }
    ngAfterViewInit() {
        // lancio la ricerca
        Promise.resolve().then(() => {
            this.ds.fetchNextPage();
        });
        this.scrollerEl.addEventListener('scroll', this.scrollerFunctionRef, { capture: true, passive: true });
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
        this.scrollerEl.removeEventListener('scroll', this.scrollerFunctionRef, true);
    }
    itemClicked(item, ev) {
        this.itemClick.next(item);
        if (this.selectable) {
            if (this.multiselect && this.clickedOnMultiselectHandler(ev)) {
                this.siiListController.multiselectItemClick(item);
            }
            else {
                this.siiListController.singleselectItemClick(item);
            }
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: InfiniteScrollComponent, deps: [{ token: i0.ElementRef }, { token: i1.SiiListController }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "18.2.13", type: InfiniteScrollComponent, isStandalone: true, selector: "sii-infinite-scroll", inputs: { multiselect: "multiselect", selectable: "selectable" }, outputs: { itemClick: "itemClick" }, queries: [{ propertyName: "templateRef", first: true, predicate: ListRowDirective, descendants: true, read: TemplateRef }, { propertyName: "noDataFoundTpl", first: true, predicate: EmptyListMessageDirective, descendants: true, read: TemplateRef }], ngImport: i0, template: "@if (siiListController.fetchInProgressObs | async) {\r\n  <mat-progress-bar mode=\"query\"></mat-progress-bar>\r\n}\r\n<div class=\"infiniteScrollListContainer\" #vs_ref  >\r\n  <ng-content select=\"[listHeader]\"></ng-content>\r\n\r\n  @if (initialized && ds.listSize==0 && !(siiListController.fetchInProgressObs | async)) {\r\n    <div class=\"emptyListContainer\">\r\n      <ng-container  *ngTemplateOutlet=\"noDataFoundTpl || defaultEmptyData\" ></ng-container>\r\n    </div>\r\n  }\r\n\r\n  @for (item of ds.data | async  ; track item; let index = $index; let last = $last) {\r\n    <div\r\n      class=\"infiniteScrollItem\" [class.sii-infinite-scroll-selected]=\"item && siiListController.isSelected(item)\" (click)=\"itemClicked(item,$event)\">\r\n      <ng-container *ngTemplateOutlet=\"templateRef; context:{$implicit:item, index:index, items:ds.dataValue,  prev: (index==0?null : ds.dataValue[index-1]), next:(last?null:ds.dataValue[index+1])}\" ></ng-container>\r\n    </div>\r\n  }\r\n  <ng-content select=\"[listFooter]\"></ng-content>\r\n</div>\r\n\r\n\r\n<ng-template #defaultEmptyData>\r\n  <sii-banner-feedback type='info' style=\"flex:1\" >\r\n    <div feedback-toolbar>No Data Found</div>\r\n  </sii-banner-feedback>\r\n</ng-template>\r\n", styles: [":host{display:flex;width:100%;position:relative}.infiniteScrollListContainer{width:100%;display:flex;flex-direction:row;flex-wrap:wrap;justify-content:space-around;align-items:flex-start;align-content:flex-start}mat-progress-bar{position:fixed;z-index:1}.emptyListContainer{display:flex;padding:10px;width:100%;box-sizing:border-box}.infiniteScrollItem{display:contents}\n"], dependencies: [{ kind: "component", type: MatProgressBar, selector: "mat-progress-bar", inputs: ["color", "value", "bufferValue", "mode"], outputs: ["animationEnd"], exportAs: ["matProgressBar"] }, { kind: "directive", type: NgTemplateOutlet, selector: "[ngTemplateOutlet]", inputs: ["ngTemplateOutletContext", "ngTemplateOutlet", "ngTemplateOutletInjector"] }, { kind: "component", type: BannerFeedbackComponent, selector: "sii-banner-feedback", inputs: ["type"] }, { kind: "pipe", type: AsyncPipe, name: "async" }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: InfiniteScrollComponent, decorators: [{
            type: Component,
            args: [{ selector: 'sii-infinite-scroll', standalone: true, imports: [MatProgressBar, NgTemplateOutlet, BannerFeedbackComponent, AsyncPipe], template: "@if (siiListController.fetchInProgressObs | async) {\r\n  <mat-progress-bar mode=\"query\"></mat-progress-bar>\r\n}\r\n<div class=\"infiniteScrollListContainer\" #vs_ref  >\r\n  <ng-content select=\"[listHeader]\"></ng-content>\r\n\r\n  @if (initialized && ds.listSize==0 && !(siiListController.fetchInProgressObs | async)) {\r\n    <div class=\"emptyListContainer\">\r\n      <ng-container  *ngTemplateOutlet=\"noDataFoundTpl || defaultEmptyData\" ></ng-container>\r\n    </div>\r\n  }\r\n\r\n  @for (item of ds.data | async  ; track item; let index = $index; let last = $last) {\r\n    <div\r\n      class=\"infiniteScrollItem\" [class.sii-infinite-scroll-selected]=\"item && siiListController.isSelected(item)\" (click)=\"itemClicked(item,$event)\">\r\n      <ng-container *ngTemplateOutlet=\"templateRef; context:{$implicit:item, index:index, items:ds.dataValue,  prev: (index==0?null : ds.dataValue[index-1]), next:(last?null:ds.dataValue[index+1])}\" ></ng-container>\r\n    </div>\r\n  }\r\n  <ng-content select=\"[listFooter]\"></ng-content>\r\n</div>\r\n\r\n\r\n<ng-template #defaultEmptyData>\r\n  <sii-banner-feedback type='info' style=\"flex:1\" >\r\n    <div feedback-toolbar>No Data Found</div>\r\n  </sii-banner-feedback>\r\n</ng-template>\r\n", styles: [":host{display:flex;width:100%;position:relative}.infiniteScrollListContainer{width:100%;display:flex;flex-direction:row;flex-wrap:wrap;justify-content:space-around;align-items:flex-start;align-content:flex-start}mat-progress-bar{position:fixed;z-index:1}.emptyListContainer{display:flex;padding:10px;width:100%;box-sizing:border-box}.infiniteScrollItem{display:contents}\n"] }]
        }], ctorParameters: () => [{ type: i0.ElementRef }, { type: i1.SiiListController }], propDecorators: { templateRef: [{
                type: ContentChild,
                args: [ListRowDirective, { read: TemplateRef }]
            }], noDataFoundTpl: [{
                type: ContentChild,
                args: [EmptyListMessageDirective, { read: TemplateRef }]
            }], multiselect: [{
                type: Input
            }], selectable: [{
                type: Input
            }], itemClick: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5maW5pdGUtc2Nyb2xsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NpaS10b29sa2l0L3NyYy9saWIvY29tcG9uZW50cy9saXN0L2luZmluaXRlLXNjcm9sbC9pbmZpbml0ZS1zY3JvbGwuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2lpLXRvb2xraXQvc3JjL2xpYi9jb21wb25lbnRzL2xpc3QvaW5maW5pdGUtc2Nyb2xsL2luZmluaXRlLXNjcm9sbC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBYSxXQUFXLEVBQXlCLE1BQU0sRUFBRSxZQUFZLEVBQWlCLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuSixPQUFPLEVBQUcsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXJDLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBRXRGLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDBEQUEwRCxDQUFDO0FBQ3JHLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDBEQUEwRCxDQUFDO0FBQ25HLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7OztBQVNoRSxNQUFNLE9BQU8sdUJBQXVCO0lBcUJsQyxZQUFvQixFQUFjLEVBQVMsaUJBQW9DO1FBQTNELE9BQUUsR0FBRixFQUFFLENBQVk7UUFBUyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBakJ0RSxnQkFBVyxHQUFHLEtBQUssQ0FBQztRQUNwQixlQUFVLEdBQUcsSUFB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LENBQUM7WUFDbkIsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxFQUFFLENBQUMsRUFBQyxDQUFDO2dCQUM1RCxJQUFJLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDcEQsQ0FBQztpQkFBSSxDQUFDO2dCQUNKLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyRCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7K0dBbkZVLHVCQUF1QjttR0FBdkIsdUJBQXVCLCtOQUVwQixnQkFBZ0IsMkJBQVMsV0FBVyw4REFDcEMseUJBQXlCLDJCQUFTLFdBQVcsNkJDckI3RCw0dUNBMkJBLDhhRFhjLGNBQWMseUtBQUUsZ0JBQWdCLG9KQUFFLHVCQUF1Qiw2RUFBRSxTQUFTOzs0RkFFckUsdUJBQXVCO2tCQVBuQyxTQUFTOytCQUNJLHFCQUFxQixjQUduQixJQUFJLFdBQ1AsQ0FBQyxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsdUJBQXVCLEVBQUUsU0FBUyxDQUFDOytHQUk1QixXQUFXO3NCQUEvRCxZQUFZO3VCQUFDLGdCQUFnQixFQUFFLEVBQUMsSUFBSSxFQUFFLFdBQVcsRUFBQztnQkFDVyxjQUFjO3NCQUEzRSxZQUFZO3VCQUFDLHlCQUF5QixFQUFFLEVBQUMsSUFBSSxFQUFFLFdBQVcsRUFBQztnQkFDbkQsV0FBVztzQkFBbkIsS0FBSztnQkFDRyxVQUFVO3NCQUFsQixLQUFLO2dCQUNJLFNBQVM7c0JBQWxCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBWaWV3Q2hpbGQsIFRlbXBsYXRlUmVmLCBFbGVtZW50UmVmLCBPbkRlc3Ryb3ksIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBBZnRlclZpZXdJbml0LCBDb250ZW50Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBTaWlMaXN0Q29udHJvbGxlciB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2Uvc2lpLWxpc3QtY29udHJvbGxlci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgU2lpSW5maW5pdGVTY3JvbGxEYXRhU291cmNlIH0gZnJvbSAnLi91dGlscy9zaWktaW5maW5pdGUtc2Nyb2xsLWRhdGEtc291cmNlJztcclxuaW1wb3J0IHsgU2Nyb2xsZXJDb21wb25lbnQgfSBmcm9tICcuLi8uLi9wYWdlLWNvbnRhaW5lci91dGlscy9kdG8vc2Nyb2xsZXItY29tcG9uZW50LmR0byc7XHJcbmltcG9ydCB7IExpc3RSb3dEaXJlY3RpdmUgfSBmcm9tICcuLi91dGlscy9saXN0LXJvdy9saXN0LXJvdy5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBFbXB0eUxpc3RNZXNzYWdlRGlyZWN0aXZlIH0gZnJvbSAnLi4vdXRpbHMvZW1wdHktbGlzdC1tZXNzYWdlL2VtcHR5LWxpc3QtbWVzc2FnZS5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBCYW5uZXJGZWVkYmFja0NvbXBvbmVudCB9IGZyb20gJy4uLy4uL2ZlZWRiYWNrL2Jhbm5lci1mZWVkYmFjay9iYW5uZXItZmVlZGJhY2suY29tcG9uZW50JztcclxuaW1wb3J0IHsgTmdUZW1wbGF0ZU91dGxldCwgQXN5bmNQaXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0IHsgTWF0UHJvZ3Jlc3NCYXIgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9wcm9ncmVzcy1iYXInO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3NpaS1pbmZpbml0ZS1zY3JvbGwnLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL2luZmluaXRlLXNjcm9sbC5jb21wb25lbnQuaHRtbCcsXHJcbiAgICBzdHlsZVVybHM6IFsnLi9pbmZpbml0ZS1zY3JvbGwuY29tcG9uZW50LmNzcyddLFxyXG4gICAgc3RhbmRhbG9uZTogdHJ1ZSxcclxuICAgIGltcG9ydHM6IFtNYXRQcm9ncmVzc0JhciwgTmdUZW1wbGF0ZU91dGxldCwgQmFubmVyRmVlZGJhY2tDb21wb25lbnQsIEFzeW5jUGlwZV1cclxufSlcclxuZXhwb3J0IGNsYXNzIEluZmluaXRlU2Nyb2xsQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95LCBTY3JvbGxlckNvbXBvbmVudHtcclxuXHJcbiAgQENvbnRlbnRDaGlsZChMaXN0Um93RGlyZWN0aXZlLCB7cmVhZDogVGVtcGxhdGVSZWZ9KSB0ZW1wbGF0ZVJlZjtcclxuICBAQ29udGVudENoaWxkKEVtcHR5TGlzdE1lc3NhZ2VEaXJlY3RpdmUsIHtyZWFkOiBUZW1wbGF0ZVJlZn0pIG5vRGF0YUZvdW5kVHBsO1xyXG4gIEBJbnB1dCgpIG11bHRpc2VsZWN0ID0gZmFsc2U7XHJcbiAgQElucHV0KCkgc2VsZWN0YWJsZSA9IHRydWU7XHJcbiAgQE91dHB1dCgpIGl0ZW1DbGljayA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBpbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xyXG5cclxuICBkcyA9IG5ldyBTaWlJbmZpbml0ZVNjcm9sbERhdGFTb3VyY2UodGhpcy5zaWlMaXN0Q29udHJvbGxlcik7XHJcblxyXG4gIC8vIEBWaWV3Q2hpbGQoJ3ZzX3JlZicpIHNjcm9sbGVSZWY6IEVsZW1lbnRSZWY7XHJcblxyXG4gIC8vIHB1YmxpYyBnZXQgc2Nyb2xsZXJFbCgpOiBIVE1MRWxlbWVudHtcclxuICAvLyAgIHJldHVybiB0aGlzLnNjcm9sbGVSZWYubmF0aXZlRWxlbWVudDtcclxuICAvLyB9XHJcbiAgcHVibGljIHNjcm9sbGVyRWwgPSBkb2N1bWVudDtcclxuXHJcblxyXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyAgZWw6IEVsZW1lbnRSZWYsIHB1YmxpYyBzaWlMaXN0Q29udHJvbGxlcjogU2lpTGlzdENvbnRyb2xsZXIpe1xyXG5cclxuXHJcbiAgICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKHNpaUxpc3RDb250cm9sbGVyLmZldGNoUGFnZURhdGEuc3Vic2NyaWJlKChyZXNwKSA9PiB7XHJcbiAgICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgIGlmIChyZXNwLnJlc2V0KXtcclxuICAgICAgICAgIHRoaXMuc2Nyb2xsZXJFbC5zY3JvbGxpbmdFbGVtZW50LnNjcm9sbFRvKHt0b3A6IDB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICAgIChcclxuICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxZID49IGRvY3VtZW50LmJvZHkub2Zmc2V0SGVpZ2h0IC8vIHNjcm9sbCBub3QgdmlzaWJsZVxyXG4gICAgICAgICAgICAgICAgfHwgdGhpcy5pc1Njcm9sbGVkQXRFbmRPZlBhZ2UoKVxyXG4gICAgICAgICAgICAgICAgLy8gfHwgdGhpcy5sYXN0U2Nyb2xsSGVpZ2h0PT09dGhpcy5zY3JvbGxlckVsLnNjcm9sbEhlaWdodCAgICAgLy8gbCd1bHRpbWEgcG9zaXppb25lIG5vbiDDqCB2YXJpYXRhXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAmJiByZXNwLnJvd3MubWF4UGFnZSA+IHJlc3Aucm93cy5jdXJyUGFnZSl7XHJcbiAgICAgICAgICAgICAgdGhpcy5kcy5mZXRjaE5leHRQYWdlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0sIDApO1xyXG4gICAgICB9XHJcbiAgICAgIClcclxuICAgICApO1xyXG5cclxuXHJcblxyXG5cclxuICB9XHJcblxyXG4gIGlzU2Nyb2xsZWRBdEVuZE9mUGFnZSgpe1xyXG4gICAgcmV0dXJuIE1hdGgucm91bmQod2luZG93LmlubmVySGVpZ2h0ICsgd2luZG93LnNjcm9sbFkpID49IGRvY3VtZW50LmJvZHkub2Zmc2V0SGVpZ2h0O1xyXG4gIH1cclxuXHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgICAvLyBsYW5jaW8gbGEgcmljZXJjYVxyXG4gICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gICB7XHJcbiAgICAgICB0aGlzLmRzLmZldGNoTmV4dFBhZ2UoKTtcclxuICAgICAgfSk7XHJcbiAgICAgdGhpcy5zY3JvbGxlckVsLmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuc2Nyb2xsZXJGdW5jdGlvblJlZiwge2NhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWV9KTtcclxuICB9XHJcblxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgdGhpcy5zY3JvbGxlckVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuc2Nyb2xsZXJGdW5jdGlvblJlZiwgdHJ1ZSk7XHJcbiAgfVxyXG5cclxuICBzY3JvbGxlckZ1bmN0aW9uUmVmID0gIChldmVudDogRXZlbnQpID0+IHtcclxuICAgICAgaWYgKGV2ZW50LnRhcmdldCA9PT0gZXZlbnQuY3VycmVudFRhcmdldCAmJiB0aGlzLmlzU2Nyb2xsZWRBdEVuZE9mUGFnZSgpKXtcclxuICAgICAgIHRoaXMuZHMuZmV0Y2hOZXh0UGFnZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaXRlbUNsaWNrZWQoaXRlbSwgZXY6IE1vdXNlRXZlbnQpe1xyXG4gICAgdGhpcy5pdGVtQ2xpY2submV4dChpdGVtKTtcclxuICAgIGlmICh0aGlzLnNlbGVjdGFibGUpe1xyXG4gICAgICBpZiAodGhpcy5tdWx0aXNlbGVjdCAmJiB0aGlzLmNsaWNrZWRPbk11bHRpc2VsZWN0SGFuZGxlcihldikpe1xyXG4gICAgICAgIHRoaXMuc2lpTGlzdENvbnRyb2xsZXIubXVsdGlzZWxlY3RJdGVtQ2xpY2soaXRlbSk7XHJcbiAgICAgIH1lbHNle1xyXG4gICAgICAgIHRoaXMuc2lpTGlzdENvbnRyb2xsZXIuc2luZ2xlc2VsZWN0SXRlbUNsaWNrKGl0ZW0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjbGlja2VkT25NdWx0aXNlbGVjdEhhbmRsZXIgPSAoZXYpID0+IHtcclxuICAgIHJldHVybiBldi50YXJnZXQuY2xvc2VzdCgnW3NpaS1saXN0LW11bHRpc2VsZWN0LWhhbmRsZXJdJykgIT09IG51bGw7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuIiwiQGlmIChzaWlMaXN0Q29udHJvbGxlci5mZXRjaEluUHJvZ3Jlc3NPYnMgfCBhc3luYykge1xyXG4gIDxtYXQtcHJvZ3Jlc3MtYmFyIG1vZGU9XCJxdWVyeVwiPjwvbWF0LXByb2dyZXNzLWJhcj5cclxufVxyXG48ZGl2IGNsYXNzPVwiaW5maW5pdGVTY3JvbGxMaXN0Q29udGFpbmVyXCIgI3ZzX3JlZiAgPlxyXG4gIDxuZy1jb250ZW50IHNlbGVjdD1cIltsaXN0SGVhZGVyXVwiPjwvbmctY29udGVudD5cclxuXHJcbiAgQGlmIChpbml0aWFsaXplZCAmJiBkcy5saXN0U2l6ZT09MCAmJiAhKHNpaUxpc3RDb250cm9sbGVyLmZldGNoSW5Qcm9ncmVzc09icyB8IGFzeW5jKSkge1xyXG4gICAgPGRpdiBjbGFzcz1cImVtcHR5TGlzdENvbnRhaW5lclwiPlxyXG4gICAgICA8bmctY29udGFpbmVyICAqbmdUZW1wbGF0ZU91dGxldD1cIm5vRGF0YUZvdW5kVHBsIHx8IGRlZmF1bHRFbXB0eURhdGFcIiA+PC9uZy1jb250YWluZXI+XHJcbiAgICA8L2Rpdj5cclxuICB9XHJcblxyXG4gIEBmb3IgKGl0ZW0gb2YgZHMuZGF0YSB8IGFzeW5jICA7IHRyYWNrIGl0ZW07IGxldCBpbmRleCA9ICRpbmRleDsgbGV0IGxhc3QgPSAkbGFzdCkge1xyXG4gICAgPGRpdlxyXG4gICAgICBjbGFzcz1cImluZmluaXRlU2Nyb2xsSXRlbVwiIFtjbGFzcy5zaWktaW5maW5pdGUtc2Nyb2xsLXNlbGVjdGVkXT1cIml0ZW0gJiYgc2lpTGlzdENvbnRyb2xsZXIuaXNTZWxlY3RlZChpdGVtKVwiIChjbGljayk9XCJpdGVtQ2xpY2tlZChpdGVtLCRldmVudClcIj5cclxuICAgICAgPG5nLWNvbnRhaW5lciAqbmdUZW1wbGF0ZU91dGxldD1cInRlbXBsYXRlUmVmOyBjb250ZXh0OnskaW1wbGljaXQ6aXRlbSwgaW5kZXg6aW5kZXgsIGl0ZW1zOmRzLmRhdGFWYWx1ZSwgIHByZXY6IChpbmRleD09MD9udWxsIDogZHMuZGF0YVZhbHVlW2luZGV4LTFdKSwgbmV4dDoobGFzdD9udWxsOmRzLmRhdGFWYWx1ZVtpbmRleCsxXSl9XCIgPjwvbmctY29udGFpbmVyPlxyXG4gICAgPC9kaXY+XHJcbiAgfVxyXG4gIDxuZy1jb250ZW50IHNlbGVjdD1cIltsaXN0Rm9vdGVyXVwiPjwvbmctY29udGVudD5cclxuPC9kaXY+XHJcblxyXG5cclxuPG5nLXRlbXBsYXRlICNkZWZhdWx0RW1wdHlEYXRhPlxyXG4gIDxzaWktYmFubmVyLWZlZWRiYWNrIHR5cGU9J2luZm8nIHN0eWxlPVwiZmxleDoxXCIgPlxyXG4gICAgPGRpdiBmZWVkYmFjay10b29sYmFyPk5vIERhdGEgRm91bmQ8L2Rpdj5cclxuICA8L3NpaS1iYW5uZXItZmVlZGJhY2s+XHJcbjwvbmctdGVtcGxhdGU+XHJcbiJdfQ==