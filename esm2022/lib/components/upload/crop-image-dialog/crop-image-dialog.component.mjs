import { Component, Inject, ViewChild } from '@angular/core';
import { MAT_DIALOG_DATA, MatDialogContent, MatDialogActions } from '@angular/material/dialog';
import { ImageCropperModule } from 'ngx-image-cropper';
import { MatIcon } from '@angular/material/icon';
import { MatIconButton, MatButton } from '@angular/material/button';
import { NgClass } from '@angular/common';
import { CdkScrollable } from '@angular/cdk/scrolling';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/dialog";
import * as i2 from "ngx-image-cropper";
export class CropImageDialogComponent {
    constructor(data, dialogRef, renderer, cdref) {
        // this.fileCanvas.nativeElement.getContext('2d').drawImage(data.file, 0, 0);
        this.data = data;
        this.dialogRef = dialogRef;
        this.renderer = renderer;
        this.cdref = cdref;
        this.utils = {
            maxWidth: 'inherit',
            rotation: 0,
            originalImageWidth: 0,
            originalImageHeight: 0,
            initImageWidth: null,
            initImageHeight: null,
            isVerticalOriginalImage: false,
            quality: 1,
            errorImageLoad: false
        };
        this.isVertical = false;
        this.croppedImage = '';
        this.loadImageFailed = () => {
            this.utils.errorImageLoad = true;
        };
        // A Blob() is almost a File() - it's just missing the two properties below which we will add
        this.blobToFile = (theBlob, fileName, mimeType) => {
            // const b: any = theBlob;
            // b.lastModifiedDate = new Date();
            // b.name = fileName;
            return new File([theBlob], fileName, { type: mimeType });
            // return theBlob as File;
        };
    }
    ngOnInit() {
    }
    onNoClick() {
        this.dialogRef.close();
    }
    confirmImage() {
        if (this.likeSize(this.cropperCanvas.nativeElement.width, this.utils.initImageWidth)
            && this.likeSize(this.cropperCanvas.nativeElement.height, this.utils.initImageHeight)) {
            // console.log('originalImage')
            if ((this.data.file.size / (1024 * 1024)) > this.data.maxSize) {
                console.log('originalImage too Big.. use edited image');
                this.dialogRef.close(this.photoToSave);
            }
            else {
                this.dialogRef.close(this.data.file);
            }
        }
        else {
            // console.log('editedImage')
            this.dialogRef.close(this.photoToSave);
        }
    }
    likeSize(size1, size2) {
        return Math.abs(size1 - size2) < 3;
    }
    rotate() {
        this.utils.rotation = (this.utils.rotation - 1) % 4;
        const tmp = this.utils.originalImageWidth;
        this.utils.originalImageWidth = this.utils.originalImageHeight;
        this.utils.originalImageHeight = tmp;
        this.croppedImage = '';
        this.calculateOriginalImageProp();
    }
    imageCropped(crop) {
        // this.croppedImage = crop.base64;
        // put the created cropped image to canvas and reduce the size
        this.renderer.setProperty(this.cropperCanvas.nativeElement, 'width', crop.width);
        this.renderer.setProperty(this.cropperCanvas.nativeElement, 'height', crop.height);
        this.isVertical = crop.width < crop.height;
        const image = new Image();
        image.onload = () => {
            this.cropperCanvas.nativeElement.getContext('2d').drawImage(image, 0, 0);
            this.updatePhotoCroppedFromCanvas(this.cropperCanvas.nativeElement, 'image/jpeg', 1.0);
        };
        image.src = crop.base64;
    }
    fileImageLoaded(data) {
        this.utils.initImageWidth = this.utils.initImageWidth || data.transformed.size.width;
        this.utils.initImageHeight = this.utils.initImageHeight || data.transformed.size.height;
        this.utils.originalImageWidth = data.transformed.size.width;
        this.utils.originalImageHeight = data.transformed.size.height;
        this.calculateOriginalImageProp();
    }
    calculateOriginalImageProp() {
        this.utils.isVerticalOriginalImage = this.utils.originalImageWidth < this.utils.originalImageHeight;
        this.utils.maxWidth = ((80 * this.utils.originalImageWidth) / this.utils.originalImageHeight) + 'vh';
    }
    updatePhotoCroppedFromCanvas(canvas, mimeType, qualityArgument) {
        canvas.toBlob((blob) => {
            const fileCreated = this.blobToFile(blob, this.data.file.name.split('.')[0].replace('_crp', '') + '_crp.jpeg', mimeType);
            if (qualityArgument < 0) {
                console.log('unable to resize image to minSize of upload');
                this.dialogRef.close(this.data.file);
            }
            // console.log('canvasBlob size:' + (blob.size / (1024 * 1024)));
            if ((fileCreated.size / (1024 * 1024)) > this.data.maxSize) {
                console.log('TOO BIG, reduce');
                this.updatePhotoCroppedFromCanvas(canvas, mimeType, qualityArgument - 0.1);
                // this.utils.quality -= 0.1;
            }
            else {
                // this.croppedImage = blob;
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    this.croppedImage = reader.result;
                    this.cdref.detectChanges();
                    this.cdref.markForCheck();
                };
                this.photoToSave = fileCreated;
                // console.log('FINAL PHOTO size:'+ (fileCreated.size/(1024*1024)),this.photoToSave)
                this.cdref.detectChanges();
                this.cdref.markForCheck();
            }
        }, mimeType, qualityArgument);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CropImageDialogComponent, deps: [{ token: MAT_DIALOG_DATA }, { token: i1.MatDialogRef }, { token: i0.Renderer2 }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "18.2.13", type: CropImageDialogComponent, isStandalone: true, selector: "sii-crop-image-dialog", viewQueries: [{ propertyName: "cropperCanvas", first: true, predicate: ["cropper_canvas"], descendants: true }], ngImport: i0, template: "<!-- <span mat-dialog-title>Take a pic</span> -->\r\n<div mat-dialog-content style=\"max-height: none;\">\r\n\r\n  @if (utils.errorImageLoad) {\r\n    <div class=\"ErrorLoadImage\" i18n=\"@@siiUploadCorruptedImage\">The Uploaded Image Is Corrupt And Cannot Be Processed</div>\r\n  }\r\n\r\n\r\n  <!-- <video #video id=\"video\" class=\"pd_video_player\" autoplay></video> -->\r\n  <!-- <canvas #file_canvas style=\"display: none;\"></canvas> -->\r\n  <canvas #cropper_canvas style=\"display: none;\"></canvas>\r\n\r\n  <!-- [resizeToWidth]=\"205\" -->\r\n  <!-- [cropperMinWidth]=\"205\" -->\r\n  <!-- [aspectRatio]=\"205 / 256\" -->\r\n  <!-- [maintainAspectRatio]=\"true\" -->\r\n  <!-- [onlyScaleDown]=\"true\" -->\r\n  @if (!utils.errorImageLoad) {\r\n    <div  class=\"pd_canvas\" [ngClass]=\"{'verticalpdCanvas':utils.isVerticalOriginalImage}\">\r\n      <image-cropper [style.maxWidth]=\"utils.maxWidth\"\r\n        [imageQuality]=\"100\"\r\n        [imageFile]=\"data.file\"\r\n        [maintainAspectRatio]=\"!!data.aspectRatio\"\r\n        [aspectRatio]=\"data.aspectRatio\"\r\n        [resizeToWidth]=\"data.resizeToWidth\"\r\n        format=\"jpeg\"\r\n        (imageCropped)=\"imageCropped($event)\"\r\n        (imageLoaded)=\"fileImageLoaded($event)\"\r\n        [canvasRotation]=\"utils.rotation\"\r\n        (loadImageFailed)=\"loadImageFailed()\"\r\n        >\r\n      </image-cropper>\r\n      <img class=\"finalImage\"  [ngClass]=\"{'verticalFinalImage':isVertical}\" [src]=\"croppedImage\" />\r\n      <button  mat-icon-button (click)=\"rotate()\" class=\"rotateButton\">\r\n        <mat-icon>crop_rotate</mat-icon>\r\n      </button>\r\n    </div>\r\n  }\r\n\r\n</div>\r\n<div mat-dialog-actions align=\"end\">\r\n  <button type=\"button\" mat-button (click)=\"onNoClick()\" i18n=\"pict@@cancelOperation\">Cancel</button>\r\n  @if (!utils.errorImageLoad) {\r\n    <button  type=\"button\" mat-raised-button color=\"primary\"   (click)=\"confirmImage()\" i18n=\"pict@@confirmPhoto\">Confirm</button>\r\n  }\r\n</div>\r\n\r\n", styles: [".pd_canvas{position:relative;margin:0 auto}image-cropper{margin:auto}.finalImage{position:absolute;bottom:15px;right:0;border:2px solid white;width:25%}.finalImage:hover{width:75%;transition-delay:1s}.finalImage.verticalFinalImage{width:auto;height:35%}.finalImage.verticalFinalImage:hover{width:auto;height:75%}.rotateButton{position:absolute;top:7px;right:0;background-color:#ffffff96}\n"], dependencies: [{ kind: "directive", type: MatDialogContent, selector: "[mat-dialog-content], mat-dialog-content, [matDialogContent]" }, { kind: "directive", type: NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "ngmodule", type: ImageCropperModule }, { kind: "component", type: i2.ImageCropperComponent, selector: "image-cropper", inputs: ["imageChangedEvent", "imageURL", "imageBase64", "imageFile", "imageAltText", "format", "transform", "maintainAspectRatio", "aspectRatio", "resetCropOnAspectRatioChange", "resizeToWidth", "resizeToHeight", "cropperMinWidth", "cropperMinHeight", "cropperMaxHeight", "cropperMaxWidth", "cropperStaticWidth", "cropperStaticHeight", "canvasRotation", "initialStepSize", "roundCropper", "onlyScaleDown", "imageQuality", "autoCrop", "backgroundColor", "containWithinAspectRatio", "hideResizeSquares", "allowMoveImage", "cropper", "alignImage", "disabled", "hidden"], outputs: ["imageCropped", "startCropImage", "imageLoaded", "cropperReady", "loadImageFailed", "transformChange"] }, { kind: "component", type: MatIconButton, selector: "button[mat-icon-button]", exportAs: ["matButton"] }, { kind: "component", type: MatIcon, selector: "mat-icon", inputs: ["color", "inline", "svgIcon", "fontSet", "fontIcon"], exportAs: ["matIcon"] }, { kind: "directive", type: MatDialogActions, selector: "[mat-dialog-actions], mat-dialog-actions, [matDialogActions]", inputs: ["align"] }, { kind: "component", type: MatButton, selector: "    button[mat-button], button[mat-raised-button], button[mat-flat-button],    button[mat-stroked-button]  ", exportAs: ["matButton"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CropImageDialogComponent, decorators: [{
            type: Component,
            args: [{ selector: 'sii-crop-image-dialog', standalone: true, imports: [CdkScrollable, MatDialogContent, NgClass, ImageCropperModule, MatIconButton, MatIcon, MatDialogActions, MatButton], template: "<!-- <span mat-dialog-title>Take a pic</span> -->\r\n<div mat-dialog-content style=\"max-height: none;\">\r\n\r\n  @if (utils.errorImageLoad) {\r\n    <div class=\"ErrorLoadImage\" i18n=\"@@siiUploadCorruptedImage\">The Uploaded Image Is Corrupt And Cannot Be Processed</div>\r\n  }\r\n\r\n\r\n  <!-- <video #video id=\"video\" class=\"pd_video_player\" autoplay></video> -->\r\n  <!-- <canvas #file_canvas style=\"display: none;\"></canvas> -->\r\n  <canvas #cropper_canvas style=\"display: none;\"></canvas>\r\n\r\n  <!-- [resizeToWidth]=\"205\" -->\r\n  <!-- [cropperMinWidth]=\"205\" -->\r\n  <!-- [aspectRatio]=\"205 / 256\" -->\r\n  <!-- [maintainAspectRatio]=\"true\" -->\r\n  <!-- [onlyScaleDown]=\"true\" -->\r\n  @if (!utils.errorImageLoad) {\r\n    <div  class=\"pd_canvas\" [ngClass]=\"{'verticalpdCanvas':utils.isVerticalOriginalImage}\">\r\n      <image-cropper [style.maxWidth]=\"utils.maxWidth\"\r\n        [imageQuality]=\"100\"\r\n        [imageFile]=\"data.file\"\r\n        [maintainAspectRatio]=\"!!data.aspectRatio\"\r\n        [aspectRatio]=\"data.aspectRatio\"\r\n        [resizeToWidth]=\"data.resizeToWidth\"\r\n        format=\"jpeg\"\r\n        (imageCropped)=\"imageCropped($event)\"\r\n        (imageLoaded)=\"fileImageLoaded($event)\"\r\n        [canvasRotation]=\"utils.rotation\"\r\n        (loadImageFailed)=\"loadImageFailed()\"\r\n        >\r\n      </image-cropper>\r\n      <img class=\"finalImage\"  [ngClass]=\"{'verticalFinalImage':isVertical}\" [src]=\"croppedImage\" />\r\n      <button  mat-icon-button (click)=\"rotate()\" class=\"rotateButton\">\r\n        <mat-icon>crop_rotate</mat-icon>\r\n      </button>\r\n    </div>\r\n  }\r\n\r\n</div>\r\n<div mat-dialog-actions align=\"end\">\r\n  <button type=\"button\" mat-button (click)=\"onNoClick()\" i18n=\"pict@@cancelOperation\">Cancel</button>\r\n  @if (!utils.errorImageLoad) {\r\n    <button  type=\"button\" mat-raised-button color=\"primary\"   (click)=\"confirmImage()\" i18n=\"pict@@confirmPhoto\">Confirm</button>\r\n  }\r\n</div>\r\n\r\n", styles: [".pd_canvas{position:relative;margin:0 auto}image-cropper{margin:auto}.finalImage{position:absolute;bottom:15px;right:0;border:2px solid white;width:25%}.finalImage:hover{width:75%;transition-delay:1s}.finalImage.verticalFinalImage{width:auto;height:35%}.finalImage.verticalFinalImage:hover{width:auto;height:75%}.rotateButton{position:absolute;top:7px;right:0;background-color:#ffffff96}\n"] }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [MAT_DIALOG_DATA]
                }] }, { type: i1.MatDialogRef }, { type: i0.Renderer2 }, { type: i0.ChangeDetectorRef }], propDecorators: { cropperCanvas: [{
                type: ViewChild,
                args: ['cropper_canvas']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JvcC1pbWFnZS1kaWFsb2cuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2lpLXRvb2xraXQvc3JjL2xpYi9jb21wb25lbnRzL3VwbG9hZC9jcm9wLWltYWdlLWRpYWxvZy9jcm9wLWltYWdlLWRpYWxvZy5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zaWktdG9vbGtpdC9zcmMvbGliL2NvbXBvbmVudHMvdXBsb2FkL2Nyb3AtaW1hZ2UtZGlhbG9nL2Nyb3AtaW1hZ2UtZGlhbG9nLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBcUIsU0FBUyxFQUFjLE1BQU0sRUFBcUIsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9HLE9BQU8sRUFBZ0IsZUFBZSxFQUFFLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDN0csT0FBTyxFQUFxQixrQkFBa0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7Ozs7QUFTdkQsTUFBTSxPQUFPLHdCQUF3QjtJQW9CbkMsWUFBNkMsSUFBSSxFQUM3QixTQUFpRCxFQUNoRCxRQUFtQixFQUNuQixLQUF3QjtRQUV2Qyw2RUFBNkU7UUFMdEMsU0FBSSxHQUFKLElBQUksQ0FBQTtRQUM3QixjQUFTLEdBQVQsU0FBUyxDQUF3QztRQUNoRCxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25CLFVBQUssR0FBTCxLQUFLLENBQW1C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LDRIQUFFLFNBQVM7OzRGQUVsSCx3QkFBd0I7a0JBUHBDLFNBQVM7K0JBQ0ksdUJBQXVCLGNBR3JCLElBQUksV0FDUCxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsYUFBYSxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLENBQUM7OzBCQXNCaEgsTUFBTTsyQkFBQyxlQUFlOzRIQUZHLGFBQWE7c0JBQW5ELFNBQVM7dUJBQUMsZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5qZWN0LCBPbkluaXQsIFJlbmRlcmVyMiwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1hdERpYWxvZ1JlZiwgTUFUX0RJQUxPR19EQVRBLCBNYXREaWFsb2dDb250ZW50LCBNYXREaWFsb2dBY3Rpb25zIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvZGlhbG9nJztcclxuaW1wb3J0IHsgSW1hZ2VDcm9wcGVkRXZlbnQsIEltYWdlQ3JvcHBlck1vZHVsZSB9IGZyb20gJ25neC1pbWFnZS1jcm9wcGVyJztcclxuaW1wb3J0IHsgTWF0SWNvbiB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2ljb24nO1xyXG5pbXBvcnQgeyBNYXRJY29uQnV0dG9uLCBNYXRCdXR0b24gfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9idXR0b24nO1xyXG5pbXBvcnQgeyBOZ0NsYXNzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0IHsgQ2RrU2Nyb2xsYWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9zY3JvbGxpbmcnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3NpaS1jcm9wLWltYWdlLWRpYWxvZycsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vY3JvcC1pbWFnZS1kaWFsb2cuY29tcG9uZW50Lmh0bWwnLFxyXG4gICAgc3R5bGVVcmxzOiBbJy4vY3JvcC1pbWFnZS1kaWFsb2cuY29tcG9uZW50LnNjc3MnXSxcclxuICAgIHN0YW5kYWxvbmU6IHRydWUsXHJcbiAgICBpbXBvcnRzOiBbQ2RrU2Nyb2xsYWJsZSwgTWF0RGlhbG9nQ29udGVudCwgTmdDbGFzcywgSW1hZ2VDcm9wcGVyTW9kdWxlLCBNYXRJY29uQnV0dG9uLCBNYXRJY29uLCBNYXREaWFsb2dBY3Rpb25zLCBNYXRCdXR0b25dXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDcm9wSW1hZ2VEaWFsb2dDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG5cclxuICB1dGlscyA9IHtcclxuICAgIG1heFdpZHRoOiAnaW5oZXJpdCcsXHJcbiAgICByb3RhdGlvbjogMCxcclxuICAgIG9yaWdpbmFsSW1hZ2VXaWR0aDogMCxcclxuICAgIG9yaWdpbmFsSW1hZ2VIZWlnaHQ6IDAsXHJcbiAgICBpbml0SW1hZ2VXaWR0aDogbnVsbCxcclxuICAgIGluaXRJbWFnZUhlaWdodDogbnVsbCxcclxuICAgIGlzVmVydGljYWxPcmlnaW5hbEltYWdlIDogZmFsc2UsXHJcbiAgICBxdWFsaXR5OiAxLFxyXG4gICAgZXJyb3JJbWFnZUxvYWQ6IGZhbHNlXHJcbiAgfTtcclxuICBpc1ZlcnRpY2FsID0gZmFsc2U7XHJcbiAgY3JvcHBlZEltYWdlOiBhbnkgPSAnJztcclxuICBwaG90b1RvU2F2ZTogRmlsZTtcclxuXHJcbiAgLy8gQFZpZXdDaGlsZCgnZmlsZV9jYW52YXMnKSAgICBwdWJsaWMgZmlsZUNhbnZhczogRWxlbWVudFJlZjtcclxuICBAVmlld0NoaWxkKCdjcm9wcGVyX2NhbnZhcycpICAgIHB1YmxpYyBjcm9wcGVyQ2FudmFzOiBFbGVtZW50UmVmO1xyXG5cclxuICBjb25zdHJ1Y3RvciggQEluamVjdChNQVRfRElBTE9HX0RBVEEpIHB1YmxpYyBkYXRhLFxyXG4gICAgICAgICAgICAgICBwdWJsaWMgZGlhbG9nUmVmOiBNYXREaWFsb2dSZWY8Q3JvcEltYWdlRGlhbG9nQ29tcG9uZW50PixcclxuICAgICAgICAgICAgICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxyXG4gICAgICAgICAgICAgICBwcml2YXRlIGNkcmVmOiBDaGFuZ2VEZXRlY3RvclJlZikge1xyXG5cclxuICAgICAgICAvLyB0aGlzLmZpbGVDYW52YXMubmF0aXZlRWxlbWVudC5nZXRDb250ZXh0KCcyZCcpLmRyYXdJbWFnZShkYXRhLmZpbGUsIDAsIDApO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgfVxyXG5cclxuICBvbk5vQ2xpY2soKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgY29uZmlybUltYWdlKCl7XHJcbiAgICBpZiAodGhpcy5saWtlU2l6ZSh0aGlzLmNyb3BwZXJDYW52YXMubmF0aXZlRWxlbWVudC53aWR0aCwgdGhpcy51dGlscy5pbml0SW1hZ2VXaWR0aClcclxuICAgICAgJiYgdGhpcy5saWtlU2l6ZSh0aGlzLmNyb3BwZXJDYW52YXMubmF0aXZlRWxlbWVudC5oZWlnaHQsIHRoaXMudXRpbHMuaW5pdEltYWdlSGVpZ2h0KSl7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ29yaWdpbmFsSW1hZ2UnKVxyXG5cclxuICAgICAgICBpZiAoKHRoaXMuZGF0YS5maWxlLnNpemUgLyAoMTAyNCAqIDEwMjQpKSA+IHRoaXMuZGF0YS5tYXhTaXplKXtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdvcmlnaW5hbEltYWdlIHRvbyBCaWcuLiB1c2UgZWRpdGVkIGltYWdlJyk7XHJcbiAgICAgICAgICB0aGlzLmRpYWxvZ1JlZi5jbG9zZSh0aGlzLnBob3RvVG9TYXZlKTtcclxuICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgIHRoaXMuZGlhbG9nUmVmLmNsb3NlKHRoaXMuZGF0YS5maWxlKTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgfWVsc2V7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ2VkaXRlZEltYWdlJylcclxuICAgICAgICB0aGlzLmRpYWxvZ1JlZi5jbG9zZSh0aGlzLnBob3RvVG9TYXZlKTtcclxuICAgICAgfVxyXG4gIH1cclxuXHJcbiAgbGlrZVNpemUoc2l6ZTEsIHNpemUyKXtcclxuICAgIHJldHVybiBNYXRoLmFicyhzaXplMSAtIHNpemUyKSA8IDM7XHJcbiAgfVxyXG5cclxuXHJcbiAgcm90YXRlKCl7XHJcbiAgICB0aGlzLnV0aWxzLnJvdGF0aW9uID0gKHRoaXMudXRpbHMucm90YXRpb24gLSAxKSAlIDQ7XHJcbiAgICBjb25zdCB0bXAgPSB0aGlzLnV0aWxzLm9yaWdpbmFsSW1hZ2VXaWR0aDtcclxuICAgIHRoaXMudXRpbHMub3JpZ2luYWxJbWFnZVdpZHRoID0gdGhpcy51dGlscy5vcmlnaW5hbEltYWdlSGVpZ2h0O1xyXG4gICAgdGhpcy51dGlscy5vcmlnaW5hbEltYWdlSGVpZ2h0ID0gdG1wO1xyXG4gICAgdGhpcy5jcm9wcGVkSW1hZ2UgPSAnJztcclxuXHJcbiAgICB0aGlzLmNhbGN1bGF0ZU9yaWdpbmFsSW1hZ2VQcm9wKCk7XHJcbiAgfVxyXG5cclxuICBpbWFnZUNyb3BwZWQoY3JvcDogSW1hZ2VDcm9wcGVkRXZlbnQpIHtcclxuICAgIC8vIHRoaXMuY3JvcHBlZEltYWdlID0gY3JvcC5iYXNlNjQ7XHJcblxyXG4gICAgLy8gcHV0IHRoZSBjcmVhdGVkIGNyb3BwZWQgaW1hZ2UgdG8gY2FudmFzIGFuZCByZWR1Y2UgdGhlIHNpemVcclxuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5jcm9wcGVyQ2FudmFzLm5hdGl2ZUVsZW1lbnQsICd3aWR0aCcsIGNyb3Aud2lkdGgpO1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmNyb3BwZXJDYW52YXMubmF0aXZlRWxlbWVudCwgJ2hlaWdodCcsIGNyb3AuaGVpZ2h0KTtcclxuXHJcbiAgICB0aGlzLmlzVmVydGljYWwgPSBjcm9wLndpZHRoIDwgY3JvcC5oZWlnaHQ7XHJcblxyXG5cclxuICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKCk7XHJcbiAgICBpbWFnZS5vbmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgIHRoaXMuY3JvcHBlckNhbnZhcy5uYXRpdmVFbGVtZW50LmdldENvbnRleHQoJzJkJykuZHJhd0ltYWdlKGltYWdlLCAwLCAwKTtcclxuICAgICAgdGhpcy51cGRhdGVQaG90b0Nyb3BwZWRGcm9tQ2FudmFzKHRoaXMuY3JvcHBlckNhbnZhcy5uYXRpdmVFbGVtZW50LCAnaW1hZ2UvanBlZycsIDEuMCk7XHJcblxyXG4gICAgfTtcclxuICAgIGltYWdlLnNyYyA9IGNyb3AuYmFzZTY0O1xyXG4gIH1cclxuXHJcbiAgZmlsZUltYWdlTG9hZGVkKGRhdGEpe1xyXG4gICAgdGhpcy51dGlscy5pbml0SW1hZ2VXaWR0aCA9IHRoaXMudXRpbHMuaW5pdEltYWdlV2lkdGggfHwgZGF0YS50cmFuc2Zvcm1lZC5zaXplLndpZHRoO1xyXG4gICAgdGhpcy51dGlscy5pbml0SW1hZ2VIZWlnaHQgPSB0aGlzLnV0aWxzLmluaXRJbWFnZUhlaWdodCB8fCBkYXRhLnRyYW5zZm9ybWVkLnNpemUuaGVpZ2h0O1xyXG4gICAgdGhpcy51dGlscy5vcmlnaW5hbEltYWdlV2lkdGggPSBkYXRhLnRyYW5zZm9ybWVkLnNpemUud2lkdGg7XHJcbiAgICB0aGlzLnV0aWxzLm9yaWdpbmFsSW1hZ2VIZWlnaHQgPSBkYXRhLnRyYW5zZm9ybWVkLnNpemUuaGVpZ2h0O1xyXG4gICAgdGhpcy5jYWxjdWxhdGVPcmlnaW5hbEltYWdlUHJvcCgpO1xyXG4gIH1cclxuXHJcbiAgY2FsY3VsYXRlT3JpZ2luYWxJbWFnZVByb3AoKXtcclxuICAgIHRoaXMudXRpbHMuaXNWZXJ0aWNhbE9yaWdpbmFsSW1hZ2UgPSB0aGlzLnV0aWxzLm9yaWdpbmFsSW1hZ2VXaWR0aCA8IHRoaXMudXRpbHMub3JpZ2luYWxJbWFnZUhlaWdodDtcclxuICAgIHRoaXMudXRpbHMubWF4V2lkdGggPSAoKDgwICogdGhpcy51dGlscy5vcmlnaW5hbEltYWdlV2lkdGgpIC8gdGhpcy51dGlscy5vcmlnaW5hbEltYWdlSGVpZ2h0ICkgKyAndmgnIDtcclxuXHJcbiAgfVxyXG5cclxuXHJcbiAgdXBkYXRlUGhvdG9Dcm9wcGVkRnJvbUNhbnZhcyhjYW52YXMsIG1pbWVUeXBlOiBzdHJpbmcsIHF1YWxpdHlBcmd1bWVudDogbnVtYmVyKXtcclxuXHJcblxyXG4gICAgY2FudmFzLnRvQmxvYigoYmxvYikgPT4ge1xyXG4gICAgY29uc3QgZmlsZUNyZWF0ZWQgPSB0aGlzLmJsb2JUb0ZpbGUoYmxvYiwgdGhpcy5kYXRhLmZpbGUubmFtZS5zcGxpdCgnLicpWzBdLnJlcGxhY2UoJ19jcnAnLCAnJykgKyAnX2NycC5qcGVnJywgbWltZVR5cGUpO1xyXG4gICAgaWYgKHF1YWxpdHlBcmd1bWVudCA8IDApe1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCd1bmFibGUgdG8gcmVzaXplIGltYWdlIHRvIG1pblNpemUgb2YgdXBsb2FkJyk7XHJcbiAgICAgICAgdGhpcy5kaWFsb2dSZWYuY2xvc2UodGhpcy5kYXRhLmZpbGUpO1xyXG4gICAgICB9XHJcbiAgICAvLyBjb25zb2xlLmxvZygnY2FudmFzQmxvYiBzaXplOicgKyAoYmxvYi5zaXplIC8gKDEwMjQgKiAxMDI0KSkpO1xyXG4gICAgaWYgKChmaWxlQ3JlYXRlZC5zaXplIC8gKDEwMjQgKiAxMDI0KSkgPiB0aGlzLmRhdGEubWF4U2l6ZSl7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdUT08gQklHLCByZWR1Y2UnKTtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVQaG90b0Nyb3BwZWRGcm9tQ2FudmFzKGNhbnZhcywgbWltZVR5cGUsIHF1YWxpdHlBcmd1bWVudCAtIDAuMSk7XHJcbiAgICAgICAgICAgIC8vIHRoaXMudXRpbHMucXVhbGl0eSAtPSAwLjE7XHJcbiAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgLy8gdGhpcy5jcm9wcGVkSW1hZ2UgPSBibG9iO1xyXG4gICAgICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChibG9iKTtcclxuICAgICAgICAgICAgcmVhZGVyLm9ubG9hZGVuZCA9ICgpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLmNyb3BwZWRJbWFnZSA9ICByZWFkZXIucmVzdWx0O1xyXG4gICAgICAgICAgICAgIHRoaXMuY2RyZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICAgIHRoaXMuY2RyZWYubWFya0ZvckNoZWNrKCk7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB0aGlzLnBob3RvVG9TYXZlID0gZmlsZUNyZWF0ZWQ7XHJcblxyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnRklOQUwgUEhPVE8gc2l6ZTonKyAoZmlsZUNyZWF0ZWQuc2l6ZS8oMTAyNCoxMDI0KSksdGhpcy5waG90b1RvU2F2ZSlcclxuICAgICAgICAgICAgdGhpcy5jZHJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgIHRoaXMuY2RyZWYubWFya0ZvckNoZWNrKCk7XHJcbiAgICAgICAgICB9XHJcblxyXG5cclxuICAgIH0sIG1pbWVUeXBlLCBxdWFsaXR5QXJndW1lbnQpO1xyXG4gIH1cclxuXHJcbiAgbG9hZEltYWdlRmFpbGVkID0gKCkgPT4ge1xyXG4gICAgdGhpcy51dGlscy5lcnJvckltYWdlTG9hZCA9IHRydWU7XHJcbiAgfVxyXG5cclxuICAgIC8vIEEgQmxvYigpIGlzIGFsbW9zdCBhIEZpbGUoKSAtIGl0J3MganVzdCBtaXNzaW5nIHRoZSB0d28gcHJvcGVydGllcyBiZWxvdyB3aGljaCB3ZSB3aWxsIGFkZFxyXG4gICAgcHVibGljIGJsb2JUb0ZpbGUgPSAodGhlQmxvYjogQmxvYiwgZmlsZU5hbWU6IHN0cmluZywgbWltZVR5cGU6IHN0cmluZyk6IEZpbGUgPT4ge1xyXG4gICAgICAvLyBjb25zdCBiOiBhbnkgPSB0aGVCbG9iO1xyXG4gICAgICAvLyBiLmxhc3RNb2RpZmllZERhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAvLyBiLm5hbWUgPSBmaWxlTmFtZTtcclxuICAgICAgcmV0dXJuIG5ldyBGaWxlKFt0aGVCbG9iXSwgZmlsZU5hbWUsIHt0eXBlOiBtaW1lVHlwZX0pO1xyXG4gICAgICAvLyByZXR1cm4gdGhlQmxvYiBhcyBGaWxlO1xyXG4gIH1cclxuXHJcbn1cclxuIiwiPCEtLSA8c3BhbiBtYXQtZGlhbG9nLXRpdGxlPlRha2UgYSBwaWM8L3NwYW4+IC0tPlxyXG48ZGl2IG1hdC1kaWFsb2ctY29udGVudCBzdHlsZT1cIm1heC1oZWlnaHQ6IG5vbmU7XCI+XHJcblxyXG4gIEBpZiAodXRpbHMuZXJyb3JJbWFnZUxvYWQpIHtcclxuICAgIDxkaXYgY2xhc3M9XCJFcnJvckxvYWRJbWFnZVwiIGkxOG49XCJAQHNpaVVwbG9hZENvcnJ1cHRlZEltYWdlXCI+VGhlIFVwbG9hZGVkIEltYWdlIElzIENvcnJ1cHQgQW5kIENhbm5vdCBCZSBQcm9jZXNzZWQ8L2Rpdj5cclxuICB9XHJcblxyXG5cclxuICA8IS0tIDx2aWRlbyAjdmlkZW8gaWQ9XCJ2aWRlb1wiIGNsYXNzPVwicGRfdmlkZW9fcGxheWVyXCIgYXV0b3BsYXk+PC92aWRlbz4gLS0+XHJcbiAgPCEtLSA8Y2FudmFzICNmaWxlX2NhbnZhcyBzdHlsZT1cImRpc3BsYXk6IG5vbmU7XCI+PC9jYW52YXM+IC0tPlxyXG4gIDxjYW52YXMgI2Nyb3BwZXJfY2FudmFzIHN0eWxlPVwiZGlzcGxheTogbm9uZTtcIj48L2NhbnZhcz5cclxuXHJcbiAgPCEtLSBbcmVzaXplVG9XaWR0aF09XCIyMDVcIiAtLT5cclxuICA8IS0tIFtjcm9wcGVyTWluV2lkdGhdPVwiMjA1XCIgLS0+XHJcbiAgPCEtLSBbYXNwZWN0UmF0aW9dPVwiMjA1IC8gMjU2XCIgLS0+XHJcbiAgPCEtLSBbbWFpbnRhaW5Bc3BlY3RSYXRpb109XCJ0cnVlXCIgLS0+XHJcbiAgPCEtLSBbb25seVNjYWxlRG93bl09XCJ0cnVlXCIgLS0+XHJcbiAgQGlmICghdXRpbHMuZXJyb3JJbWFnZUxvYWQpIHtcclxuICAgIDxkaXYgIGNsYXNzPVwicGRfY2FudmFzXCIgW25nQ2xhc3NdPVwieyd2ZXJ0aWNhbHBkQ2FudmFzJzp1dGlscy5pc1ZlcnRpY2FsT3JpZ2luYWxJbWFnZX1cIj5cclxuICAgICAgPGltYWdlLWNyb3BwZXIgW3N0eWxlLm1heFdpZHRoXT1cInV0aWxzLm1heFdpZHRoXCJcclxuICAgICAgICBbaW1hZ2VRdWFsaXR5XT1cIjEwMFwiXHJcbiAgICAgICAgW2ltYWdlRmlsZV09XCJkYXRhLmZpbGVcIlxyXG4gICAgICAgIFttYWludGFpbkFzcGVjdFJhdGlvXT1cIiEhZGF0YS5hc3BlY3RSYXRpb1wiXHJcbiAgICAgICAgW2FzcGVjdFJhdGlvXT1cImRhdGEuYXNwZWN0UmF0aW9cIlxyXG4gICAgICAgIFtyZXNpemVUb1dpZHRoXT1cImRhdGEucmVzaXplVG9XaWR0aFwiXHJcbiAgICAgICAgZm9ybWF0PVwianBlZ1wiXHJcbiAgICAgICAgKGltYWdlQ3JvcHBlZCk9XCJpbWFnZUNyb3BwZWQoJGV2ZW50KVwiXHJcbiAgICAgICAgKGltYWdlTG9hZGVkKT1cImZpbGVJbWFnZUxvYWRlZCgkZXZlbnQpXCJcclxuICAgICAgICBbY2FudmFzUm90YXRpb25dPVwidXRpbHMucm90YXRpb25cIlxyXG4gICAgICAgIChsb2FkSW1hZ2VGYWlsZWQpPVwibG9hZEltYWdlRmFpbGVkKClcIlxyXG4gICAgICAgID5cclxuICAgICAgPC9pbWFnZS1jcm9wcGVyPlxyXG4gICAgICA8aW1nIGNsYXNzPVwiZmluYWxJbWFnZVwiICBbbmdDbGFzc109XCJ7J3ZlcnRpY2FsRmluYWxJbWFnZSc6aXNWZXJ0aWNhbH1cIiBbc3JjXT1cImNyb3BwZWRJbWFnZVwiIC8+XHJcbiAgICAgIDxidXR0b24gIG1hdC1pY29uLWJ1dHRvbiAoY2xpY2spPVwicm90YXRlKClcIiBjbGFzcz1cInJvdGF0ZUJ1dHRvblwiPlxyXG4gICAgICAgIDxtYXQtaWNvbj5jcm9wX3JvdGF0ZTwvbWF0LWljb24+XHJcbiAgICAgIDwvYnV0dG9uPlxyXG4gICAgPC9kaXY+XHJcbiAgfVxyXG5cclxuPC9kaXY+XHJcbjxkaXYgbWF0LWRpYWxvZy1hY3Rpb25zIGFsaWduPVwiZW5kXCI+XHJcbiAgPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgbWF0LWJ1dHRvbiAoY2xpY2spPVwib25Ob0NsaWNrKClcIiBpMThuPVwicGljdEBAY2FuY2VsT3BlcmF0aW9uXCI+Q2FuY2VsPC9idXR0b24+XHJcbiAgQGlmICghdXRpbHMuZXJyb3JJbWFnZUxvYWQpIHtcclxuICAgIDxidXR0b24gIHR5cGU9XCJidXR0b25cIiBtYXQtcmFpc2VkLWJ1dHRvbiBjb2xvcj1cInByaW1hcnlcIiAgIChjbGljayk9XCJjb25maXJtSW1hZ2UoKVwiIGkxOG49XCJwaWN0QEBjb25maXJtUGhvdG9cIj5Db25maXJtPC9idXR0b24+XHJcbiAgfVxyXG48L2Rpdj5cclxuXHJcbiJdfQ==