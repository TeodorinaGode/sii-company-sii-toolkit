import { Component, HostBinding, Inject, ViewChild } from '@angular/core';
import { MAT_DIALOG_DATA, MatDialogContent, MatDialogActions, MatDialogClose } from '@angular/material/dialog';
import { ImageCropperModule } from 'ngx-image-cropper';
import { MatIcon } from '@angular/material/icon';
import { MatButton, MatFabButton } from '@angular/material/button';
import { NgClass } from '@angular/common';
import { CdkScrollable } from '@angular/cdk/scrolling';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/dialog";
import * as i2 from "ngx-image-cropper";
export class PictDialogComponent {
    constructor(data, cdref, renderer, dialogRef) {
        this.data = data;
        this.cdref = cdref;
        this.renderer = renderer;
        this.dialogRef = dialogRef;
        this.pictDone = false;
        this.videoWidth = 0;
        this.videoHeight = 0;
        this.videoActive = false;
        this.isVertical = false;
        this.croppedImage = '';
        this.cameraConstraints = {
            video: {
                width: { ideal: 4096 },
                height: { ideal: 2160 }
            }
        };
        // createFile(canvas,mimeType:string, qualityArgument:number){
        //   canvas.toBlob((blob) =>{
        //     const fileCreated=this.blobToFile(blob,'image'+new Date().getTime()+'.jpeg',mimeType);
        //     if((fileCreated.size/(1024*1024))>this.data.maxSize){
        //       this.createFile(canvas, mimeType,qualityArgument-0.1)
        //     }else{
        //       this.photoToSave=fileCreated;
        //       this.cdref.detectChanges();
        //       this.cdref.markForCheck();
        //     }
        //   }, mimeType,qualityArgument);
        // }
        // A Blob() is almost a File() - it's just missing the two properties below which we will add
        this.blobToFile = (theBlob, fileName, mimeType) => {
            // const b: any = theBlob;
            // b.lastModifiedDate = new Date();
            // b.name = fileName;
            return new File([theBlob], fileName, { type: mimeType });
            // return theBlob as File;
        };
    }
    ngOnInit() {
        this.startCamera();
    }
    ngOnDestroy() {
        this.stopVideo();
    }
    startCamera() {
        this.pictDone = false;
        this.photoToSave = null;
        if (!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
            navigator.mediaDevices.getUserMedia(this.cameraConstraints)
                .then((stream) => { this.videoStream = stream; this.attachVideo(); })
                .catch((error) => alert(error));
        }
        else {
            alert('Sorry, camera not available.');
        }
    }
    attachVideo() {
        this.renderer.setProperty(this.videoElement.nativeElement, 'srcObject', this.videoStream);
        this.renderer.listen(this.videoElement.nativeElement, 'play', (event) => {
            this.videoHeight = this.videoElement.nativeElement.videoHeight;
            this.videoWidth = this.videoElement.nativeElement.videoWidth;
            this.videoActive = true;
        });
    }
    stopVideo() {
        this.videoStream.getTracks().forEach(element => { element.stop(); });
        this.videoActive = false;
    }
    onNoClick() {
        this.dialogRef.close();
    }
    doPict() {
        this.renderer.setProperty(this.videoCanvas.nativeElement, 'width', this.videoWidth);
        this.renderer.setProperty(this.videoCanvas.nativeElement, 'height', this.videoHeight);
        this.videoCanvas.nativeElement.getContext('2d').drawImage(this.videoElement.nativeElement, 0, 0);
        this.stopVideo();
        this.updatePhotoExtractionFromCanvas(this.videoCanvas.nativeElement, 'image/jpeg', 1.0);
    }
    updatePhotoExtractionFromCanvas(canvas, mimeType, qualityArgument) {
        canvas.toBlob((blob) => {
            // const fileCreated=this.blobToFile(blob,'image'+new Date().getTime()+'.jpeg',mimeType);
            // console.log(fileCreated)
            this.canvasPhotoExtraction = blob;
            // console.log('firstCanvasSize '+ this.blobToFile(blob,'image'+new Date().getTime()+'.jpeg',mimeType).size);
            this.cdref.detectChanges();
            this.cdref.markForCheck();
        }, mimeType, qualityArgument);
    }
    webCamIageLoaded() {
        this.pictDone = true;
    }
    imageCropped(crop) {
        // this.croppedImage = crop.base64;
        // put the created cropped image to canvas and reduce the size
        this.renderer.setProperty(this.cropperCanvas.nativeElement, 'width', crop.width);
        this.renderer.setProperty(this.cropperCanvas.nativeElement, 'height', crop.height);
        this.isVertical = crop.width < crop.height;
        const image = new Image();
        image.onload = () => {
            this.cropperCanvas.nativeElement.getContext('2d').drawImage(image, 0, 0);
            this.updatePhotoCroppedFromCanvas(this.cropperCanvas.nativeElement, 'image/jpeg', 0.92);
        };
        image.src = crop.base64;
    }
    updatePhotoCroppedFromCanvas(canvas, mimeType, qualityArgument) {
        canvas.toBlob((blob) => {
            console.log('canvasBlob size:' + (blob.size / (1024 * 1024)));
            const fileCreated = this.blobToFile(blob, 'image' + new Date().getTime() + '.jpeg', mimeType);
            if ((fileCreated.size / (1024 * 1024)) > this.data.maxSize) {
                console.log('TOO BIG, reduce');
                this.updatePhotoCroppedFromCanvas(canvas, mimeType, qualityArgument - 0.1);
            }
            else {
                // this.croppedImage = blob;
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => this.croppedImage = reader.result;
                this.photoToSave = fileCreated;
                // console.log('FINAL PHOTO size:'+ (fileCreated.size/(1024*1024)),this.photoToSave)
                this.cdref.detectChanges();
                this.cdref.markForCheck();
            }
        }, mimeType, qualityArgument);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: PictDialogComponent, deps: [{ token: MAT_DIALOG_DATA }, { token: i0.ChangeDetectorRef }, { token: i0.Renderer2 }, { token: i1.MatDialogRef }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "18.2.13", type: PictDialogComponent, isStandalone: true, selector: "sii-pict-dialog", host: { properties: { "class.pictDone": "this.pictDone" } }, viewQueries: [{ propertyName: "videoElement", first: true, predicate: ["video"], descendants: true }, { propertyName: "videoCanvas", first: true, predicate: ["video_canvas"], descendants: true }, { propertyName: "cropperCanvas", first: true, predicate: ["cropper_canvas"], descendants: true }], ngImport: i0, template: "<!-- <span mat-dialog-title>Take a pic</span> -->\r\n<div mat-dialog-content style=\"max-height: none;\">\r\n  <video #video id=\"video\" class=\"pd_video_player\" autoplay></video>\r\n  <canvas #video_canvas style=\"display: none;\"></canvas>\r\n  <canvas #cropper_canvas style=\"display: none;\"></canvas>\r\n\r\n  <!-- [resizeToWidth]=\"205\" -->\r\n  <!-- [cropperMinWidth]=\"205\" -->\r\n  <!-- [aspectRatio]=\"205 / 256\" -->\r\n  <!-- [maintainAspectRatio]=\"true\" -->\r\n  <!-- [onlyScaleDown]=\"true\" -->\r\n  <!-- [imageQuality]=\"100\" -->\r\n  <div class=\"pd_canvas\">\r\n    <image-cropper\r\n      [imageFile]=\"canvasPhotoExtraction\"\r\n      [maintainAspectRatio]=\"!!data.aspectRatio\"\r\n      [aspectRatio]=\"data.aspectRatio\"\r\n      [resizeToWidth]=\"data.resizeToWidth\"\r\n      format=\"jpeg\"\r\n      (imageCropped)=\"imageCropped($event)\"\r\n      (imageLoaded)=\"webCamIageLoaded()\" >\r\n    </image-cropper>\r\n    <img class=\"finalImage\"  [ngClass]=\"{'verticalFinalImage':isVertical}\" [src]=\"croppedImage\" />\r\n  </div>\r\n\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button type=\"button\" mat-button (click)=\"onNoClick()\" i18n=\"pict@@cancelOperation\">Cancel</button>\r\n  <span style=\"flex: 1;\"></span>\r\n  <button type=\"button\" mat-stroked-button class=\"ricatturaImmagine\"   (click)=\"startCamera()\" i18n=\"pict@@retry\">Retry</button>\r\n  <button type=\"button\" [disabled]=\"!videoActive\" mat-fab class=\"catturaImmagine\"    (click)=\"doPict()\" cdkFocusInitial><mat-icon>photo_camera</mat-icon></button>\r\n  <span style=\"flex: 1;\"></span>\r\n  <button type=\"button\" mat-raised-button color=\"primary\" [disabled]=\"!photoToSave\"  [mat-dialog-close]=\"photoToSave\" i18n=\"pict@@confirmPhoto\">Confirm</button>\r\n</div>\r\n\r\n", styles: [".pd_video_player,.pd_canvas{width:100vh;max-width:70vw}.pd_canvas{display:none;position:relative}.finalImage{position:absolute;bottom:15px;right:0;border:2px solid white;width:25%}.finalImage:hover{width:75%;transition-delay:1s}.finalImage.verticalFinalImage{width:auto;height:35%}.finalImage.verticalFinalImage:hover{width:auto;height:75%}:host.pictDone .pd_canvas{display:block}:host.pictDone .pd_video_player{display:none}.ricatturaImmagine{display:none}:host.pictDone .ricatturaImmagine{display:block}:host.pictDone .catturaImmagine{display:none}\n"], dependencies: [{ kind: "directive", type: MatDialogContent, selector: "[mat-dialog-content], mat-dialog-content, [matDialogContent]" }, { kind: "ngmodule", type: ImageCropperModule }, { kind: "component", type: i2.ImageCropperComponent, selector: "image-cropper", inputs: ["imageChangedEvent", "imageURL", "imageBase64", "imageFile", "imageAltText", "format", "transform", "maintainAspectRatio", "aspectRatio", "resetCropOnAspectRatioChange", "resizeToWidth", "resizeToHeight", "cropperMinWidth", "cropperMinHeight", "cropperMaxHeight", "cropperMaxWidth", "cropperStaticWidth", "cropperStaticHeight", "canvasRotation", "initialStepSize", "roundCropper", "onlyScaleDown", "imageQuality", "autoCrop", "backgroundColor", "containWithinAspectRatio", "hideResizeSquares", "allowMoveImage", "cropper", "alignImage", "disabled", "hidden"], outputs: ["imageCropped", "startCropImage", "imageLoaded", "cropperReady", "loadImageFailed", "transformChange"] }, { kind: "directive", type: NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: MatDialogActions, selector: "[mat-dialog-actions], mat-dialog-actions, [matDialogActions]", inputs: ["align"] }, { kind: "component", type: MatButton, selector: "    button[mat-button], button[mat-raised-button], button[mat-flat-button],    button[mat-stroked-button]  ", exportAs: ["matButton"] }, { kind: "component", type: MatFabButton, selector: "button[mat-fab]", inputs: ["extended"], exportAs: ["matButton"] }, { kind: "component", type: MatIcon, selector: "mat-icon", inputs: ["color", "inline", "svgIcon", "fontSet", "fontIcon"], exportAs: ["matIcon"] }, { kind: "directive", type: MatDialogClose, selector: "[mat-dialog-close], [matDialogClose]", inputs: ["aria-label", "type", "mat-dialog-close", "matDialogClose"], exportAs: ["matDialogClose"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: PictDialogComponent, decorators: [{
            type: Component,
            args: [{ selector: 'sii-pict-dialog', standalone: true, imports: [CdkScrollable, MatDialogContent, ImageCropperModule, NgClass, MatDialogActions, MatButton, MatFabButton, MatIcon, MatDialogClose], template: "<!-- <span mat-dialog-title>Take a pic</span> -->\r\n<div mat-dialog-content style=\"max-height: none;\">\r\n  <video #video id=\"video\" class=\"pd_video_player\" autoplay></video>\r\n  <canvas #video_canvas style=\"display: none;\"></canvas>\r\n  <canvas #cropper_canvas style=\"display: none;\"></canvas>\r\n\r\n  <!-- [resizeToWidth]=\"205\" -->\r\n  <!-- [cropperMinWidth]=\"205\" -->\r\n  <!-- [aspectRatio]=\"205 / 256\" -->\r\n  <!-- [maintainAspectRatio]=\"true\" -->\r\n  <!-- [onlyScaleDown]=\"true\" -->\r\n  <!-- [imageQuality]=\"100\" -->\r\n  <div class=\"pd_canvas\">\r\n    <image-cropper\r\n      [imageFile]=\"canvasPhotoExtraction\"\r\n      [maintainAspectRatio]=\"!!data.aspectRatio\"\r\n      [aspectRatio]=\"data.aspectRatio\"\r\n      [resizeToWidth]=\"data.resizeToWidth\"\r\n      format=\"jpeg\"\r\n      (imageCropped)=\"imageCropped($event)\"\r\n      (imageLoaded)=\"webCamIageLoaded()\" >\r\n    </image-cropper>\r\n    <img class=\"finalImage\"  [ngClass]=\"{'verticalFinalImage':isVertical}\" [src]=\"croppedImage\" />\r\n  </div>\r\n\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button type=\"button\" mat-button (click)=\"onNoClick()\" i18n=\"pict@@cancelOperation\">Cancel</button>\r\n  <span style=\"flex: 1;\"></span>\r\n  <button type=\"button\" mat-stroked-button class=\"ricatturaImmagine\"   (click)=\"startCamera()\" i18n=\"pict@@retry\">Retry</button>\r\n  <button type=\"button\" [disabled]=\"!videoActive\" mat-fab class=\"catturaImmagine\"    (click)=\"doPict()\" cdkFocusInitial><mat-icon>photo_camera</mat-icon></button>\r\n  <span style=\"flex: 1;\"></span>\r\n  <button type=\"button\" mat-raised-button color=\"primary\" [disabled]=\"!photoToSave\"  [mat-dialog-close]=\"photoToSave\" i18n=\"pict@@confirmPhoto\">Confirm</button>\r\n</div>\r\n\r\n", styles: [".pd_video_player,.pd_canvas{width:100vh;max-width:70vw}.pd_canvas{display:none;position:relative}.finalImage{position:absolute;bottom:15px;right:0;border:2px solid white;width:25%}.finalImage:hover{width:75%;transition-delay:1s}.finalImage.verticalFinalImage{width:auto;height:35%}.finalImage.verticalFinalImage:hover{width:auto;height:75%}:host.pictDone .pd_canvas{display:block}:host.pictDone .pd_video_player{display:none}.ricatturaImmagine{display:none}:host.pictDone .ricatturaImmagine{display:block}:host.pictDone .catturaImmagine{display:none}\n"] }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [MAT_DIALOG_DATA]
                }] }, { type: i0.ChangeDetectorRef }, { type: i0.Renderer2 }, { type: i1.MatDialogRef }], propDecorators: { videoElement: [{
                type: ViewChild,
                args: ['video']
            }], videoCanvas: [{
                type: ViewChild,
                args: ['video_canvas']
            }], cropperCanvas: [{
                type: ViewChild,
                args: ['cropper_canvas']
            }], pictDone: [{
                type: HostBinding,
                args: ['class.pictDone']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGljdC1kaWFsb2cuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2lpLXRvb2xraXQvc3JjL2xpYi9jb21wb25lbnRzL3VwbG9hZC9waWN0LWRpYWxvZy9waWN0LWRpYWxvZy5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zaWktdG9vbGtpdC9zcmMvbGliL2NvbXBvbmVudHMvdXBsb2FkL3BpY3QtZGlhbG9nL3BpY3QtZGlhbG9nLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBcUIsU0FBUyxFQUFjLFdBQVcsRUFBRSxNQUFNLEVBQWdDLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2SSxPQUFPLEVBQWdCLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3SCxPQUFPLEVBQW1DLGtCQUFrQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDeEYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDbkUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQzs7OztBQVN2RCxNQUFNLE9BQU8sbUJBQW1CO0lBd0I5QixZQUErQyxJQUFJLEVBQVUsS0FBd0IsRUFDOUQsUUFBbUIsRUFBVSxTQUE0QztRQURqRCxTQUFJLEdBQUosSUFBSSxDQUFBO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBbUI7UUFDOUQsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUFVLGNBQVMsR0FBVCxTQUFTLENBQW1DO1FBcEJqRSxhQUFRLEdBQUcsS0FBSyxDQUFD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Q1AsQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLEVBQUUsa0JBQWtCLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLGNBQWMsQ0FBQzs7MEJBMEI3SCxNQUFNOzJCQUFDLGVBQWU7NEhBdkJsQixZQUFZO3NCQUEvQixTQUFTO3VCQUFDLE9BQU87Z0JBQ21CLFdBQVc7c0JBQS9DLFNBQVM7dUJBQUMsY0FBYztnQkFDYyxhQUFhO3NCQUFuRCxTQUFTO3VCQUFDLGdCQUFnQjtnQkFFSSxRQUFRO3NCQUF0QyxXQUFXO3VCQUFDLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEhvc3RCaW5kaW5nLCBJbmplY3QsIE9uRGVzdHJveSwgT25Jbml0LCBSZW5kZXJlcjIsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBNYXREaWFsb2dSZWYsIE1BVF9ESUFMT0dfREFUQSwgTWF0RGlhbG9nQ29udGVudCwgTWF0RGlhbG9nQWN0aW9ucywgTWF0RGlhbG9nQ2xvc2UgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9kaWFsb2cnO1xyXG5pbXBvcnQgeyBiYXNlNjRUb0ZpbGUsIEltYWdlQ3JvcHBlZEV2ZW50LCBJbWFnZUNyb3BwZXJNb2R1bGUgfSBmcm9tICduZ3gtaW1hZ2UtY3JvcHBlcic7XHJcbmltcG9ydCB7IE1hdEljb24gfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9pY29uJztcclxuaW1wb3J0IHsgTWF0QnV0dG9uLCBNYXRGYWJCdXR0b24gfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9idXR0b24nO1xyXG5pbXBvcnQgeyBOZ0NsYXNzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0IHsgQ2RrU2Nyb2xsYWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9zY3JvbGxpbmcnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3NpaS1waWN0LWRpYWxvZycsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vcGljdC1kaWFsb2cuY29tcG9uZW50Lmh0bWwnLFxyXG4gICAgc3R5bGVVcmxzOiBbJy4vcGljdC1kaWFsb2cuY29tcG9uZW50LmNzcyddLFxyXG4gICAgc3RhbmRhbG9uZTogdHJ1ZSxcclxuICAgIGltcG9ydHM6IFtDZGtTY3JvbGxhYmxlLCBNYXREaWFsb2dDb250ZW50LCBJbWFnZUNyb3BwZXJNb2R1bGUsIE5nQ2xhc3MsIE1hdERpYWxvZ0FjdGlvbnMsIE1hdEJ1dHRvbiwgTWF0RmFiQnV0dG9uLCBNYXRJY29uLCBNYXREaWFsb2dDbG9zZV1cclxufSlcclxuZXhwb3J0IGNsYXNzIFBpY3REaWFsb2dDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSAge1xyXG4gIEBWaWV3Q2hpbGQoJ3ZpZGVvJykgdmlkZW9FbGVtZW50OiBFbGVtZW50UmVmO1xyXG4gIEBWaWV3Q2hpbGQoJ3ZpZGVvX2NhbnZhcycpICAgIHB1YmxpYyB2aWRlb0NhbnZhczogRWxlbWVudFJlZjtcclxuICBAVmlld0NoaWxkKCdjcm9wcGVyX2NhbnZhcycpICAgIHB1YmxpYyBjcm9wcGVyQ2FudmFzOiBFbGVtZW50UmVmO1xyXG5cclxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLnBpY3REb25lJykgcGljdERvbmUgPSBmYWxzZTtcclxuXHJcbiAgcGhvdG9Ub1NhdmU6IEZpbGU7XHJcbiAgY2FudmFzUGhvdG9FeHRyYWN0aW9uO1xyXG4gIHZpZGVvU3RyZWFtO1xyXG4gIHZpZGVvV2lkdGggPSAwO1xyXG4gIHZpZGVvSGVpZ2h0ID0gMDtcclxuICB2aWRlb0FjdGl2ZSA9IGZhbHNlO1xyXG4gIGlzVmVydGljYWwgPSBmYWxzZTtcclxuICBjcm9wcGVkSW1hZ2U6IGFueSA9ICcnO1xyXG5cclxuICBjYW1lcmFDb25zdHJhaW50cyA9IHtcclxuICAgIHZpZGVvOiB7XHJcbiAgICAgICAgd2lkdGg6IHsgaWRlYWw6IDQwOTYgfSxcclxuICAgICAgICBoZWlnaHQ6IHsgaWRlYWw6IDIxNjAgfVxyXG4gICAgfVxyXG59O1xyXG5cclxuXHJcbiAgY29uc3RydWN0b3IoICAgQEluamVjdChNQVRfRElBTE9HX0RBVEEpIHB1YmxpYyBkYXRhLCBwcml2YXRlIGNkcmVmOiBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgICAgICAgICAgICAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsICBwdWJsaWMgZGlhbG9nUmVmOiBNYXREaWFsb2dSZWY8UGljdERpYWxvZ0NvbXBvbmVudD4gKSB7fVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuc3RhcnRDYW1lcmEoKTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5zdG9wVmlkZW8oKTtcclxuICAgfVxyXG5cclxuXHJcbiAgc3RhcnRDYW1lcmEoKSB7XHJcbiAgICB0aGlzLnBpY3REb25lID0gZmFsc2U7XHJcbiAgICB0aGlzLnBob3RvVG9TYXZlID0gbnVsbDtcclxuICAgIGlmICghIShuYXZpZ2F0b3IubWVkaWFEZXZpY2VzICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKSkge1xyXG4gICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSh0aGlzLmNhbWVyYUNvbnN0cmFpbnRzKVxyXG4gICAgICAudGhlbigoc3RyZWFtKSA9PiB7dGhpcy52aWRlb1N0cmVhbSA9IHN0cmVhbTsgdGhpcy5hdHRhY2hWaWRlbygpOyB9KVxyXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiBhbGVydChlcnJvcikpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBhbGVydCgnU29ycnksIGNhbWVyYSBub3QgYXZhaWxhYmxlLicpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG5cclxuICAgIGF0dGFjaFZpZGVvKCkge1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMudmlkZW9FbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICdzcmNPYmplY3QnLCB0aGlzLnZpZGVvU3RyZWFtKTtcclxuICAgICAgdGhpcy5yZW5kZXJlci5saXN0ZW4odGhpcy52aWRlb0VsZW1lbnQubmF0aXZlRWxlbWVudCwgJ3BsYXknLCAoZXZlbnQpID0+IHtcclxuICAgICAgICB0aGlzLnZpZGVvSGVpZ2h0ID0gdGhpcy52aWRlb0VsZW1lbnQubmF0aXZlRWxlbWVudC52aWRlb0hlaWdodDtcclxuICAgICAgICB0aGlzLnZpZGVvV2lkdGggPSB0aGlzLnZpZGVvRWxlbWVudC5uYXRpdmVFbGVtZW50LnZpZGVvV2lkdGg7XHJcbiAgICAgICAgdGhpcy52aWRlb0FjdGl2ZSA9IHRydWU7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHN0b3BWaWRlbygpe1xyXG4gICAgICB0aGlzLnZpZGVvU3RyZWFtLmdldFRyYWNrcygpLmZvckVhY2goZWxlbWVudCA9PiB7ZWxlbWVudC5zdG9wKCk7ICB9KTtcclxuICAgICAgdGhpcy52aWRlb0FjdGl2ZSA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICBvbk5vQ2xpY2soKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgZG9QaWN0KCl7XHJcbiAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMudmlkZW9DYW52YXMubmF0aXZlRWxlbWVudCwgJ3dpZHRoJywgdGhpcy52aWRlb1dpZHRoKTtcclxuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy52aWRlb0NhbnZhcy5uYXRpdmVFbGVtZW50LCAnaGVpZ2h0JywgdGhpcy52aWRlb0hlaWdodCk7XHJcbiAgICB0aGlzLnZpZGVvQ2FudmFzLm5hdGl2ZUVsZW1lbnQuZ2V0Q29udGV4dCgnMmQnKS5kcmF3SW1hZ2UodGhpcy52aWRlb0VsZW1lbnQubmF0aXZlRWxlbWVudCwgMCwgMCk7XHJcbiAgICB0aGlzLnN0b3BWaWRlbygpO1xyXG4gICAgdGhpcy51cGRhdGVQaG90b0V4dHJhY3Rpb25Gcm9tQ2FudmFzKHRoaXMudmlkZW9DYW52YXMubmF0aXZlRWxlbWVudCwgJ2ltYWdlL2pwZWcnLCAxLjApO1xyXG4gIH1cclxuXHJcblxyXG4gIHVwZGF0ZVBob3RvRXh0cmFjdGlvbkZyb21DYW52YXMoY2FudmFzLCBtaW1lVHlwZTogc3RyaW5nLCBxdWFsaXR5QXJndW1lbnQ6IG51bWJlcil7XHJcbiAgICBjYW52YXMudG9CbG9iKChibG9iKSA9PiB7XHJcbiAgICAgIC8vIGNvbnN0IGZpbGVDcmVhdGVkPXRoaXMuYmxvYlRvRmlsZShibG9iLCdpbWFnZScrbmV3IERhdGUoKS5nZXRUaW1lKCkrJy5qcGVnJyxtaW1lVHlwZSk7XHJcbiAgICAgIC8vIGNvbnNvbGUubG9nKGZpbGVDcmVhdGVkKVxyXG4gICAgICB0aGlzLmNhbnZhc1Bob3RvRXh0cmFjdGlvbiA9IGJsb2I7XHJcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdmaXJzdENhbnZhc1NpemUgJysgdGhpcy5ibG9iVG9GaWxlKGJsb2IsJ2ltYWdlJytuZXcgRGF0ZSgpLmdldFRpbWUoKSsnLmpwZWcnLG1pbWVUeXBlKS5zaXplKTtcclxuXHJcbiAgICAgIHRoaXMuY2RyZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICB0aGlzLmNkcmVmLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgfSwgbWltZVR5cGUsIHF1YWxpdHlBcmd1bWVudCk7XHJcbiAgfVxyXG5cclxuICB3ZWJDYW1JYWdlTG9hZGVkKCl7XHJcbiAgICB0aGlzLnBpY3REb25lID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIGltYWdlQ3JvcHBlZChjcm9wOiBJbWFnZUNyb3BwZWRFdmVudCkge1xyXG4gICAgLy8gdGhpcy5jcm9wcGVkSW1hZ2UgPSBjcm9wLmJhc2U2NDtcclxuXHJcbiAgICAvLyBwdXQgdGhlIGNyZWF0ZWQgY3JvcHBlZCBpbWFnZSB0byBjYW52YXMgYW5kIHJlZHVjZSB0aGUgc2l6ZVxyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmNyb3BwZXJDYW52YXMubmF0aXZlRWxlbWVudCwgJ3dpZHRoJywgY3JvcC53aWR0aCk7XHJcbiAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuY3JvcHBlckNhbnZhcy5uYXRpdmVFbGVtZW50LCAnaGVpZ2h0JywgY3JvcC5oZWlnaHQpO1xyXG5cclxuICAgIHRoaXMuaXNWZXJ0aWNhbCA9IGNyb3Aud2lkdGggPCBjcm9wLmhlaWdodDtcclxuXHJcblxyXG4gICAgY29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcclxuICAgIGltYWdlLm9ubG9hZCA9ICgpID0+IHtcclxuICAgICAgdGhpcy5jcm9wcGVyQ2FudmFzLm5hdGl2ZUVsZW1lbnQuZ2V0Q29udGV4dCgnMmQnKS5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDApO1xyXG4gICAgICB0aGlzLnVwZGF0ZVBob3RvQ3JvcHBlZEZyb21DYW52YXModGhpcy5jcm9wcGVyQ2FudmFzLm5hdGl2ZUVsZW1lbnQsICdpbWFnZS9qcGVnJywgMC45Mik7XHJcblxyXG4gICAgfTtcclxuICAgIGltYWdlLnNyYyA9IGNyb3AuYmFzZTY0O1xyXG4gIH1cclxuXHJcblxyXG4gIHVwZGF0ZVBob3RvQ3JvcHBlZEZyb21DYW52YXMoY2FudmFzLCBtaW1lVHlwZTogc3RyaW5nLCBxdWFsaXR5QXJndW1lbnQ6IG51bWJlcil7XHJcbiAgICBjYW52YXMudG9CbG9iKChibG9iKSA9PiB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdjYW52YXNCbG9iIHNpemU6JyArIChibG9iLnNpemUgLyAoMTAyNCAqIDEwMjQpKSk7XHJcbiAgICAgIGNvbnN0IGZpbGVDcmVhdGVkID0gdGhpcy5ibG9iVG9GaWxlKGJsb2IsICdpbWFnZScgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICcuanBlZycsIG1pbWVUeXBlKTtcclxuICAgICAgaWYgKChmaWxlQ3JlYXRlZC5zaXplIC8gKDEwMjQgKiAxMDI0KSkgPiB0aGlzLmRhdGEubWF4U2l6ZSl7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdUT08gQklHLCByZWR1Y2UnKTtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVQaG90b0Nyb3BwZWRGcm9tQ2FudmFzKGNhbnZhcywgbWltZVR5cGUsIHF1YWxpdHlBcmd1bWVudCAtIDAuMSk7XHJcbiAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgLy8gdGhpcy5jcm9wcGVkSW1hZ2UgPSBibG9iO1xyXG4gICAgICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChibG9iKTtcclxuICAgICAgICAgICAgcmVhZGVyLm9ubG9hZGVuZCA9ICgpID0+IHRoaXMuY3JvcHBlZEltYWdlID0gIHJlYWRlci5yZXN1bHQ7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnBob3RvVG9TYXZlID0gZmlsZUNyZWF0ZWQ7XHJcblxyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnRklOQUwgUEhPVE8gc2l6ZTonKyAoZmlsZUNyZWF0ZWQuc2l6ZS8oMTAyNCoxMDI0KSksdGhpcy5waG90b1RvU2F2ZSlcclxuICAgICAgICAgICAgdGhpcy5jZHJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgIHRoaXMuY2RyZWYubWFya0ZvckNoZWNrKCk7XHJcbiAgICAgICAgICB9XHJcblxyXG5cclxuICAgIH0sIG1pbWVUeXBlLCBxdWFsaXR5QXJndW1lbnQpO1xyXG4gIH1cclxuXHJcblxyXG5cclxuICAvLyBjcmVhdGVGaWxlKGNhbnZhcyxtaW1lVHlwZTpzdHJpbmcsIHF1YWxpdHlBcmd1bWVudDpudW1iZXIpe1xyXG4gIC8vICAgY2FudmFzLnRvQmxvYigoYmxvYikgPT57XHJcbiAgLy8gICAgIGNvbnN0IGZpbGVDcmVhdGVkPXRoaXMuYmxvYlRvRmlsZShibG9iLCdpbWFnZScrbmV3IERhdGUoKS5nZXRUaW1lKCkrJy5qcGVnJyxtaW1lVHlwZSk7XHJcbiAgLy8gICAgIGlmKChmaWxlQ3JlYXRlZC5zaXplLygxMDI0KjEwMjQpKT50aGlzLmRhdGEubWF4U2l6ZSl7XHJcbiAgLy8gICAgICAgdGhpcy5jcmVhdGVGaWxlKGNhbnZhcywgbWltZVR5cGUscXVhbGl0eUFyZ3VtZW50LTAuMSlcclxuICAvLyAgICAgfWVsc2V7XHJcbiAgLy8gICAgICAgdGhpcy5waG90b1RvU2F2ZT1maWxlQ3JlYXRlZDtcclxuICAvLyAgICAgICB0aGlzLmNkcmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAvLyAgICAgICB0aGlzLmNkcmVmLm1hcmtGb3JDaGVjaygpO1xyXG4gIC8vICAgICB9XHJcblxyXG4gIC8vICAgfSwgbWltZVR5cGUscXVhbGl0eUFyZ3VtZW50KTtcclxuICAvLyB9XHJcblxyXG4gIC8vIEEgQmxvYigpIGlzIGFsbW9zdCBhIEZpbGUoKSAtIGl0J3MganVzdCBtaXNzaW5nIHRoZSB0d28gcHJvcGVydGllcyBiZWxvdyB3aGljaCB3ZSB3aWxsIGFkZFxyXG4gIHB1YmxpYyBibG9iVG9GaWxlID0gKHRoZUJsb2I6IEJsb2IsIGZpbGVOYW1lOiBzdHJpbmcsIG1pbWVUeXBlOiBzdHJpbmcpOiBGaWxlID0+IHtcclxuICAgIC8vIGNvbnN0IGI6IGFueSA9IHRoZUJsb2I7XHJcbiAgICAvLyBiLmxhc3RNb2RpZmllZERhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgLy8gYi5uYW1lID0gZmlsZU5hbWU7XHJcbiAgICByZXR1cm4gbmV3IEZpbGUoW3RoZUJsb2JdLCBmaWxlTmFtZSwge3R5cGU6IG1pbWVUeXBlfSk7XHJcbiAgICAvLyByZXR1cm4gdGhlQmxvYiBhcyBGaWxlO1xyXG59XHJcblxyXG59XHJcbiIsIjwhLS0gPHNwYW4gbWF0LWRpYWxvZy10aXRsZT5UYWtlIGEgcGljPC9zcGFuPiAtLT5cclxuPGRpdiBtYXQtZGlhbG9nLWNvbnRlbnQgc3R5bGU9XCJtYXgtaGVpZ2h0OiBub25lO1wiPlxyXG4gIDx2aWRlbyAjdmlkZW8gaWQ9XCJ2aWRlb1wiIGNsYXNzPVwicGRfdmlkZW9fcGxheWVyXCIgYXV0b3BsYXk+PC92aWRlbz5cclxuICA8Y2FudmFzICN2aWRlb19jYW52YXMgc3R5bGU9XCJkaXNwbGF5OiBub25lO1wiPjwvY2FudmFzPlxyXG4gIDxjYW52YXMgI2Nyb3BwZXJfY2FudmFzIHN0eWxlPVwiZGlzcGxheTogbm9uZTtcIj48L2NhbnZhcz5cclxuXHJcbiAgPCEtLSBbcmVzaXplVG9XaWR0aF09XCIyMDVcIiAtLT5cclxuICA8IS0tIFtjcm9wcGVyTWluV2lkdGhdPVwiMjA1XCIgLS0+XHJcbiAgPCEtLSBbYXNwZWN0UmF0aW9dPVwiMjA1IC8gMjU2XCIgLS0+XHJcbiAgPCEtLSBbbWFpbnRhaW5Bc3BlY3RSYXRpb109XCJ0cnVlXCIgLS0+XHJcbiAgPCEtLSBbb25seVNjYWxlRG93bl09XCJ0cnVlXCIgLS0+XHJcbiAgPCEtLSBbaW1hZ2VRdWFsaXR5XT1cIjEwMFwiIC0tPlxyXG4gIDxkaXYgY2xhc3M9XCJwZF9jYW52YXNcIj5cclxuICAgIDxpbWFnZS1jcm9wcGVyXHJcbiAgICAgIFtpbWFnZUZpbGVdPVwiY2FudmFzUGhvdG9FeHRyYWN0aW9uXCJcclxuICAgICAgW21haW50YWluQXNwZWN0UmF0aW9dPVwiISFkYXRhLmFzcGVjdFJhdGlvXCJcclxuICAgICAgW2FzcGVjdFJhdGlvXT1cImRhdGEuYXNwZWN0UmF0aW9cIlxyXG4gICAgICBbcmVzaXplVG9XaWR0aF09XCJkYXRhLnJlc2l6ZVRvV2lkdGhcIlxyXG4gICAgICBmb3JtYXQ9XCJqcGVnXCJcclxuICAgICAgKGltYWdlQ3JvcHBlZCk9XCJpbWFnZUNyb3BwZWQoJGV2ZW50KVwiXHJcbiAgICAgIChpbWFnZUxvYWRlZCk9XCJ3ZWJDYW1JYWdlTG9hZGVkKClcIiA+XHJcbiAgICA8L2ltYWdlLWNyb3BwZXI+XHJcbiAgICA8aW1nIGNsYXNzPVwiZmluYWxJbWFnZVwiICBbbmdDbGFzc109XCJ7J3ZlcnRpY2FsRmluYWxJbWFnZSc6aXNWZXJ0aWNhbH1cIiBbc3JjXT1cImNyb3BwZWRJbWFnZVwiIC8+XHJcbiAgPC9kaXY+XHJcblxyXG48L2Rpdj5cclxuPGRpdiBtYXQtZGlhbG9nLWFjdGlvbnM+XHJcbiAgPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgbWF0LWJ1dHRvbiAoY2xpY2spPVwib25Ob0NsaWNrKClcIiBpMThuPVwicGljdEBAY2FuY2VsT3BlcmF0aW9uXCI+Q2FuY2VsPC9idXR0b24+XHJcbiAgPHNwYW4gc3R5bGU9XCJmbGV4OiAxO1wiPjwvc3Bhbj5cclxuICA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBtYXQtc3Ryb2tlZC1idXR0b24gY2xhc3M9XCJyaWNhdHR1cmFJbW1hZ2luZVwiICAgKGNsaWNrKT1cInN0YXJ0Q2FtZXJhKClcIiBpMThuPVwicGljdEBAcmV0cnlcIj5SZXRyeTwvYnV0dG9uPlxyXG4gIDxidXR0b24gdHlwZT1cImJ1dHRvblwiIFtkaXNhYmxlZF09XCIhdmlkZW9BY3RpdmVcIiBtYXQtZmFiIGNsYXNzPVwiY2F0dHVyYUltbWFnaW5lXCIgICAgKGNsaWNrKT1cImRvUGljdCgpXCIgY2RrRm9jdXNJbml0aWFsPjxtYXQtaWNvbj5waG90b19jYW1lcmE8L21hdC1pY29uPjwvYnV0dG9uPlxyXG4gIDxzcGFuIHN0eWxlPVwiZmxleDogMTtcIj48L3NwYW4+XHJcbiAgPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgbWF0LXJhaXNlZC1idXR0b24gY29sb3I9XCJwcmltYXJ5XCIgW2Rpc2FibGVkXT1cIiFwaG90b1RvU2F2ZVwiICBbbWF0LWRpYWxvZy1jbG9zZV09XCJwaG90b1RvU2F2ZVwiIGkxOG49XCJwaWN0QEBjb25maXJtUGhvdG9cIj5Db25maXJtPC9idXR0b24+XHJcbjwvZGl2PlxyXG5cclxuIl19