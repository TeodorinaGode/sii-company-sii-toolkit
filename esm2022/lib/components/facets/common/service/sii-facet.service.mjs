import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import * as i0 from "@angular/core";
export class SiiFacetService {
    constructor() {
        this.facetObj = {};
        this.facetObjForBackEnd = {}; // mappa name, array di cod
        this.facetObjVal = {};
        this.selecteditemCount = 0;
        this.facetLabelMap = {};
        this.facetsMultiplicity = {};
        this.facetsHideSelection = {};
        this.facetsExpanded = {};
        this._textSerch = '';
        this._initFacetToSet = { searchText: '', facets: {} };
        this.facetChangeSubj = new Subject();
        this.facetChange$ = this.facetChangeSubj.asObservable().pipe(debounceTime(1000));
        this.facetResetSubj = new Subject();
        this.facetReset$ = this.facetResetSubj.asObservable();
        this.removeFacetSelectionSubj = new Subject();
        this.removeFacetSelection$ = this.removeFacetSelectionSubj.asObservable();
        this.removeAllFacetSelectionSubj = new Subject();
        this.removeAllFacetSelection$ = this.removeAllFacetSelectionSubj.asObservable();
        this.changeFacetsRequestSubj = new Subject();
        this.changeFacetsRequestObs = this.changeFacetsRequestSubj.asObservable();
        this.changeSearchTextRequestSubj = new Subject();
        this.changeSearchTextRequestObs = this.changeSearchTextRequestSubj.asObservable();
        this.searchFilterChange = (txt, propagateChange = true) => {
            this._textSerch = txt;
            if (propagateChange) {
                this.emitFacetChange();
            }
        };
    }
    get haveSearchText() { return this._textSerch.length > 0 ? true : false; }
    initializeFacet(name, optionsInitValue) {
        this.facetObj[name] = optionsInitValue;
        this.buildSelectionData();
        this.buildBackendData();
    }
    registerFacetLabel(key, label) {
        Promise.resolve().then(() => { this.facetLabelMap[key] = label; });
    }
    facetChange(facetChange, propagateChange = true) {
        this.facetObj[facetChange.name] = facetChange.facetOptions;
        this.buildSelectionData();
        this.buildBackendData();
        if (propagateChange) {
            this.emitFacetChange();
        }
    }
    emitFacetChange() {
        this.facetChangeSubj.next({ facets: this.facetObjForBackEnd, searchText: this._textSerch });
    }
    setInitFacets(initFacets) {
        this._initFacetToSet = initFacets;
    }
    removeFacetSelectionFromFacetSummary(facetChange) {
        this.removeFacetSelectionSubj.next(facetChange);
    }
    removeAllFilters() {
        this.removeAllFacetSelectionSubj.next();
        Promise.resolve().then(() => {
            // this.facetChangeSubj.next(this.facetObjForBackEnd);
            this.facetResetSubj.next({ facets: this.facetObjForBackEnd, searchText: '' });
        });
    }
    buildBackendData() {
        // build the obj for the backend
        const tmpFacetObjVal = {};
        for (const key in this.facetObj) {
            if (this.facetObj[key] != null) { // necessario per tslint
                if (this.facetObj[key] instanceof Array) {
                    tmpFacetObjVal[key] = this.facetObj[key].map(s => s.code);
                }
                else if (this.facetObj[key] instanceof Object && this.facetObj[key].hasOwnProperty('code')) {
                    tmpFacetObjVal[key] = this.facetObj[key].code;
                }
                else {
                    tmpFacetObjVal[key] = this.facetObj[key];
                }
            }
        }
        this.facetObjForBackEnd = tmpFacetObjVal;
    }
    buildSelectionData() {
        const tmpFacetObjVal = {};
        let count = 0;
        for (const key in this.facetObj) {
            if (this.facetObj[key] != null) { // necessario per tslint
                if (this.facetObj[key] instanceof Array) {
                    tmpFacetObjVal[key] = this.facetObj[key].reduce((acc, val) => { acc[val.code] = true; return acc; }, {});
                    count += this.facetObj[key].length;
                }
                else {
                    tmpFacetObjVal[key] = this.facetObj[key];
                    count += this.facetObj[key] ? 1 : 0;
                }
            }
        }
        this.facetObjVal = tmpFacetObjVal;
        this.selecteditemCount = count;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: SiiFacetService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: SiiFacetService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: SiiFacetService, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lpLWZhY2V0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zaWktdG9vbGtpdC9zcmMvbGliL2NvbXBvbmVudHMvZmFjZXRzL2NvbW1vbi9zZXJ2aWNlL3NpaS1mYWNldC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUcvQixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBTzlDLE1BQU0sT0FBTyxlQUFlO0lBRDVCO1FBRUUsYUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNkLHVCQUFrQixHQUFHLEVBQUUsQ0FBQyxDQUFDLDJCQUEyQjtRQUNwRCxnQkFBVyxHQUFHLEVBQUUsQ0FBQztRQUNqQixzQkFBaUIsR0FBRyxDQUFDLENBQUM7UUFFdEIsa0JBQWEsR0FBRyxFQUFFLENBQUM7UUFDbkIsdUJBQWtCLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLHdCQUFtQixHQUFHLEVBQUUsQ0FBQztRQUN6QixtQkFBYyxHQUFHLEVBQUUsQ0FBQztRQUNwQixlQUFVLEdBQUcsRUFBRSxDQUFDO1FBRWhCLG9CQUFlLEdBQW9CLEVBQUMsVUFBVSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFDLENBQUM7UUFHeEQsb0JBQWUsR0FBRyxJQUFJLE9BQU8sRUFBbUIsQ0FBQztRQUN6RCxpQkFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXBFLG1CQUFjLEdBQUcsSUFBSSxPQUFPLEVBQW1CLENBQUM7UUFDeEQsZ0JBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksRUFBRSxDQUFDO1FB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QUFDLElBQUksSUFBSSxFQUFDLENBQUMsQ0FBQyx3QkFBd0I7Z0JBQ3ZELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsWUFBYSxLQUFLLEVBQUMsQ0FBQztvQkFDeEMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDekcsS0FBSyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO2dCQUNyQyxDQUFDO3FCQUNHLENBQUM7b0JBQ0gsY0FBYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ3pDLEtBQUssSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEMsQ0FBQztZQUVILENBQUM7UUFDSCxDQUFDO1FBQ0QsSUFBSSxDQUFDLFdBQVcsR0FBRyxjQUFjLENBQUM7UUFDbEMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztJQUNqQyxDQUFDOytHQXJIVSxlQUFlO21IQUFmLGVBQWU7OzRGQUFmLGVBQWU7a0JBRDNCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgU2lpRmFjZXREdG8gfSBmcm9tICcuLi9kdG8vaS1zaWktZmFjZXQuZHRvJztcclxuaW1wb3J0IHsgU2lpRmFjZXRPcHRpb25EdG8gfSBmcm9tICcuLi9kdG8vaS1zaWktZmFjZXQtb3B0aW9uLmR0byc7XHJcbmltcG9ydCB7IGRlYm91bmNlVGltZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgU2lpU29ydERUTyB9IGZyb20gJy4uLy4uLy4uLy4uL2R0by9pLXNpaS1zb3J0LmR0byc7XHJcbmltcG9ydCB7IFNpaVNvcnRHcm91cCB9IGZyb20gJy4uLy4uLy4uLy4uL2R0by9pLXNpaS1ncm91cC5kdG8nO1xyXG5cclxuZXhwb3J0IHR5cGUgRmFjZXRDaGFuZ2VzRHRvPSB7ZmFjZXRzOiBvYmplY3QsIHNlYXJjaFRleHQ6IHN0cmluZywgc29ydD86IFNpaVNvcnREVE87ICBncm91cD86IFNpaVNvcnRHcm91cDsgfTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFNpaUZhY2V0U2VydmljZXtcclxuICBmYWNldE9iaiA9IHt9O1xyXG4gIGZhY2V0T2JqRm9yQmFja0VuZCA9IHt9OyAvLyBtYXBwYSBuYW1lLCBhcnJheSBkaSBjb2RcclxuICBmYWNldE9ialZhbCA9IHt9O1xyXG4gIHNlbGVjdGVkaXRlbUNvdW50ID0gMDtcclxuICBzb3J0RmllbGQ6IHN0cmluZztcclxuICBmYWNldExhYmVsTWFwID0ge307XHJcbiAgZmFjZXRzTXVsdGlwbGljaXR5ID0ge307XHJcbiAgZmFjZXRzSGlkZVNlbGVjdGlvbiA9IHt9O1xyXG4gIGZhY2V0c0V4cGFuZGVkID0ge307XHJcbiAgX3RleHRTZXJjaCA9ICcnO1xyXG4gIGdldCBoYXZlU2VhcmNoVGV4dCgpOiBib29sZWFue3JldHVybiB0aGlzLl90ZXh0U2VyY2gubGVuZ3RoID4gMCA/IHRydWUgOiBmYWxzZTsgfVxyXG4gIF9pbml0RmFjZXRUb1NldDogRmFjZXRDaGFuZ2VzRHRvID0ge3NlYXJjaFRleHQ6ICcnLCBmYWNldHM6IHt9fTtcclxuXHJcblxyXG4gIHByaXZhdGUgZmFjZXRDaGFuZ2VTdWJqID0gbmV3IFN1YmplY3Q8RmFjZXRDaGFuZ2VzRHRvPigpO1xyXG4gIGZhY2V0Q2hhbmdlJCA9IHRoaXMuZmFjZXRDaGFuZ2VTdWJqLmFzT2JzZXJ2YWJsZSgpLnBpcGUoZGVib3VuY2VUaW1lKDEwMDApKTtcclxuXHJcbiAgcHJpdmF0ZSBmYWNldFJlc2V0U3ViaiA9IG5ldyBTdWJqZWN0PEZhY2V0Q2hhbmdlc0R0bz4oKTtcclxuICBmYWNldFJlc2V0JCA9IHRoaXMuZmFjZXRSZXNldFN1YmouYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlRmFjZXRTZWxlY3Rpb25TdWJqID0gbmV3IFN1YmplY3Q8U2lpRmFjZXREdG8+KCk7XHJcbiAgcmVtb3ZlRmFjZXRTZWxlY3Rpb24kID0gdGhpcy5yZW1vdmVGYWNldFNlbGVjdGlvblN1YmouYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlQWxsRmFjZXRTZWxlY3Rpb25TdWJqID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuICByZW1vdmVBbGxGYWNldFNlbGVjdGlvbiQgPSB0aGlzLnJlbW92ZUFsbEZhY2V0U2VsZWN0aW9uU3Viai5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgcHVibGljIGNoYW5nZUZhY2V0c1JlcXVlc3RTdWJqID0gbmV3IFN1YmplY3Q8e2ZhY2V0czogb2JqZWN0LCByZXNldDogYm9vbGVhbn0+KCk7XHJcbiAgY2hhbmdlRmFjZXRzUmVxdWVzdE9icyA9IHRoaXMuY2hhbmdlRmFjZXRzUmVxdWVzdFN1YmouYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gIHB1YmxpYyBjaGFuZ2VTZWFyY2hUZXh0UmVxdWVzdFN1YmogPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgY2hhbmdlU2VhcmNoVGV4dFJlcXVlc3RPYnMgPSB0aGlzLmNoYW5nZVNlYXJjaFRleHRSZXF1ZXN0U3Viai5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgaW5pdGlhbGl6ZUZhY2V0KG5hbWU6IHN0cmluZywgIG9wdGlvbnNJbml0VmFsdWU6IGFueVtdfGJvb2xlYW58c3RyaW5nKXtcclxuICAgIHRoaXMuZmFjZXRPYmpbbmFtZV0gPSBvcHRpb25zSW5pdFZhbHVlO1xyXG4gICAgdGhpcy5idWlsZFNlbGVjdGlvbkRhdGEoKTtcclxuICAgIHRoaXMuYnVpbGRCYWNrZW5kRGF0YSgpO1xyXG4gIH1cclxuXHJcbiAgc2VhcmNoRmlsdGVyQ2hhbmdlID0gKHR4dCwgcHJvcGFnYXRlQ2hhbmdlPSB0cnVlKSA9PiB7XHJcbiAgICB0aGlzLl90ZXh0U2VyY2ggPSB0eHQ7XHJcbiAgICBpZiAoIHByb3BhZ2F0ZUNoYW5nZSl7XHJcbiAgICAgIHRoaXMuZW1pdEZhY2V0Q2hhbmdlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWdpc3RlckZhY2V0TGFiZWwoa2V5LCBsYWJlbCl7XHJcbiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHt0aGlzLmZhY2V0TGFiZWxNYXBba2V5XSA9IGxhYmVsOyB9KTtcclxuICB9XHJcblxyXG4gIGZhY2V0Q2hhbmdlKGZhY2V0Q2hhbmdlOiBTaWlGYWNldER0bywgcHJvcGFnYXRlQ2hhbmdlPSB0cnVlKSB7XHJcbiAgICB0aGlzLmZhY2V0T2JqW2ZhY2V0Q2hhbmdlLm5hbWVdID0gZmFjZXRDaGFuZ2UuZmFjZXRPcHRpb25zO1xyXG4gICAgdGhpcy5idWlsZFNlbGVjdGlvbkRhdGEoKTtcclxuICAgIHRoaXMuYnVpbGRCYWNrZW5kRGF0YSgpO1xyXG4gICAgaWYgKHByb3BhZ2F0ZUNoYW5nZSl7XHJcbiAgICAgIHRoaXMuZW1pdEZhY2V0Q2hhbmdlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGVtaXRGYWNldENoYW5nZSgpe1xyXG4gICAgdGhpcy5mYWNldENoYW5nZVN1YmoubmV4dCh7ZmFjZXRzOiB0aGlzLmZhY2V0T2JqRm9yQmFja0VuZCwgc2VhcmNoVGV4dDogdGhpcy5fdGV4dFNlcmNofSk7XHJcbiAgfVxyXG5cclxuXHJcbiAgc2V0SW5pdEZhY2V0cyhpbml0RmFjZXRzOiBGYWNldENoYW5nZXNEdG8pe1xyXG4gICAgdGhpcy5faW5pdEZhY2V0VG9TZXQgPSBpbml0RmFjZXRzO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlRmFjZXRTZWxlY3Rpb25Gcm9tRmFjZXRTdW1tYXJ5KGZhY2V0Q2hhbmdlOiBTaWlGYWNldER0bykge1xyXG4gICAgdGhpcy5yZW1vdmVGYWNldFNlbGVjdGlvblN1YmoubmV4dChmYWNldENoYW5nZSk7XHJcbiAgfVxyXG5cclxuICByZW1vdmVBbGxGaWx0ZXJzKCl7XHJcbiAgICB0aGlzLnJlbW92ZUFsbEZhY2V0U2VsZWN0aW9uU3Viai5uZXh0KCk7XHJcbiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHtcclxuICAgICAgLy8gdGhpcy5mYWNldENoYW5nZVN1YmoubmV4dCh0aGlzLmZhY2V0T2JqRm9yQmFja0VuZCk7XHJcbiAgICAgIHRoaXMuZmFjZXRSZXNldFN1YmoubmV4dCh7ZmFjZXRzOiB0aGlzLmZhY2V0T2JqRm9yQmFja0VuZCwgc2VhcmNoVGV4dDogJyd9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYnVpbGRCYWNrZW5kRGF0YSgpe1xyXG4gICAgLy8gYnVpbGQgdGhlIG9iaiBmb3IgdGhlIGJhY2tlbmRcclxuICAgIGNvbnN0IHRtcEZhY2V0T2JqVmFsID0ge307XHJcbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmZhY2V0T2JqKXtcclxuICAgICAgaWYgKHRoaXMuZmFjZXRPYmpba2V5XSAhPSBudWxsKXsgLy8gbmVjZXNzYXJpbyBwZXIgdHNsaW50XHJcbiAgICAgICAgaWYgKHRoaXMuZmFjZXRPYmpba2V5XSBpbnN0YW5jZW9mICBBcnJheSl7XHJcbiAgICAgICAgdG1wRmFjZXRPYmpWYWxba2V5XSA9IHRoaXMuZmFjZXRPYmpba2V5XS5tYXAocyA9PiBzLmNvZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICh0aGlzLmZhY2V0T2JqW2tleV0gaW5zdGFuY2VvZiAgT2JqZWN0ICYmIHRoaXMuZmFjZXRPYmpba2V5XS5oYXNPd25Qcm9wZXJ0eSgnY29kZScpKXtcclxuICAgICAgICAgIHRtcEZhY2V0T2JqVmFsW2tleV0gPSAodGhpcy5mYWNldE9ialtrZXldIGFzIFNpaUZhY2V0T3B0aW9uRHRvKS5jb2RlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNle1xyXG4gICAgICAgICAgdG1wRmFjZXRPYmpWYWxba2V5XSA9IHRoaXMuZmFjZXRPYmpba2V5XTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMuZmFjZXRPYmpGb3JCYWNrRW5kID0gdG1wRmFjZXRPYmpWYWw7XHJcbiAgfVxyXG5cclxuICBidWlsZFNlbGVjdGlvbkRhdGEoKXtcclxuICAgIGNvbnN0IHRtcEZhY2V0T2JqVmFsID0ge307XHJcbiAgICBsZXQgY291bnQgPSAwO1xyXG4gICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5mYWNldE9iail7XHJcbiAgICAgIGlmICh0aGlzLmZhY2V0T2JqW2tleV0gIT0gbnVsbCl7IC8vIG5lY2Vzc2FyaW8gcGVyIHRzbGludFxyXG4gICAgICAgIGlmICh0aGlzLmZhY2V0T2JqW2tleV0gaW5zdGFuY2VvZiAgQXJyYXkpe1xyXG4gICAgICAgICAgdG1wRmFjZXRPYmpWYWxba2V5XSA9IHRoaXMuZmFjZXRPYmpba2V5XS5yZWR1Y2UoKGFjYywgdmFsKSA9PiB7IGFjY1t2YWwuY29kZV0gPSB0cnVlOyByZXR1cm4gYWNjOyB9LCB7fSk7XHJcbiAgICAgICAgICBjb3VudCArPSB0aGlzLmZhY2V0T2JqW2tleV0ubGVuZ3RoO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNle1xyXG4gICAgICAgICAgdG1wRmFjZXRPYmpWYWxba2V5XSA9IHRoaXMuZmFjZXRPYmpba2V5XTtcclxuICAgICAgICAgIGNvdW50ICs9IHRoaXMuZmFjZXRPYmpba2V5XSA/IDEgOiAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMuZmFjZXRPYmpWYWwgPSB0bXBGYWNldE9ialZhbDtcclxuICAgIHRoaXMuc2VsZWN0ZWRpdGVtQ291bnQgPSBjb3VudDtcclxuICB9XHJcblxyXG5cclxuXHJcbn1cclxuIl19